<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OLED Yield & FACA Tracker ‚Äî Goerpixel / Sony</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<style>
:root {
  --navy: #1F3864;
  --navy-light: #2c4f8a;
  --green: #2E7D32;
  --green-light: #43A047;
  --amber: #E67E22;
  --red: #C0392B;
  --blue: #2980B9;
  --purple: #8E44AD;
  --teal: #16A085;
  --gray: #6c757d;
  --bg: #F0F2F5;
  --card: #FFFFFF;
  --border: #DEE2E6;
  --text: #212529;
  --text-muted: #6c757d;
  --bd-bg: #FFF9E6;
  --dd-bg: #E8F4FD;
  --cp-bg: #EBF5EB;
  --tfe-bg: #F5EEF8;
  --vl-bg: #FDEDEC;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Segoe UI', Arial, sans-serif; background: var(--bg); color: var(--text); font-size: 14px; }

/* NAV */
.nav { background: var(--navy); color: white; display: flex; align-items: center; padding: 0 20px; height: 56px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
.nav-logo { font-size: 17px; font-weight: 700; letter-spacing: 0.3px; margin-right: 32px; white-space: nowrap; }
.nav-logo span { color: #64B5F6; }
.nav-tabs { display: flex; gap: 2px; flex: 1; overflow-x: auto; }
.nav-tab { padding: 8px 16px; border-radius: 6px 6px 0 0; cursor: pointer; font-size: 13px; font-weight: 500; color: rgba(255,255,255,0.7); white-space: nowrap; transition: all 0.2s; border: none; background: transparent; }
.nav-tab:hover { color: white; background: rgba(255,255,255,0.1); }
.nav-tab.active { color: white; background: rgba(255,255,255,0.18); border-bottom: 3px solid #64B5F6; }
.nav-right { margin-left: auto; font-size: 12px; color: rgba(255,255,255,0.6); white-space: nowrap; }
.save-indicator { display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #4CAF50; margin-right: 6px; }

/* PAGES */
.page { display: none; padding: 20px; max-width: 1600px; margin: 0 auto; }
.page.active { display: block; }

/* CARDS */
.card { background: var(--card); border-radius: 10px; border: 1px solid var(--border); padding: 20px; margin-bottom: 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.06); }
.card-title { font-size: 14px; font-weight: 700; color: var(--navy); margin-bottom: 14px; display: flex; align-items: center; gap: 8px; }
.card-title .icon { font-size: 16px; }

/* GRID */
.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
.grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }
.grid-5 { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; }
@media (max-width: 1100px) { .grid-4 { grid-template-columns: repeat(2, 1fr); } .grid-5 { grid-template-columns: repeat(3, 1fr); } }
@media (max-width: 768px) { .grid-2, .grid-3, .grid-4, .grid-5 { grid-template-columns: 1fr; } }

/* KPI CARDS */
.kpi-card { background: var(--card); border-radius: 10px; border: 1px solid var(--border); padding: 16px 20px; box-shadow: 0 1px 4px rgba(0,0,0,0.06); position: relative; overflow: hidden; }
.kpi-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; }
.kpi-card.navy::before { background: var(--navy); }
.kpi-card.green::before { background: var(--green); }
.kpi-card.amber::before { background: var(--amber); }
.kpi-card.red::before { background: var(--red); }
.kpi-card.blue::before { background: var(--blue); }
.kpi-card.purple::before { background: var(--purple); }
.kpi-label { font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
.kpi-value { font-size: 28px; font-weight: 700; color: var(--navy); margin: 4px 0; }
.kpi-sub { font-size: 12px; color: var(--text-muted); }
.kpi-delta { font-size: 12px; font-weight: 600; }
.kpi-delta.up { color: var(--green); }
.kpi-delta.down { color: var(--red); }

/* EDITABLE INPUTS */
.yield-input { width: 80px; padding: 4px 8px; border: 1.5px solid var(--border); border-radius: 6px; font-size: 13px; font-weight: 600; text-align: center; color: var(--navy); background: #F8F9FA; transition: border-color 0.2s; }
.yield-input:focus { outline: none; border-color: var(--navy); background: white; }
.yield-input.changed { border-color: var(--amber); background: #FFFBF0; }

/* TABLES */
.data-table { width: 100%; border-collapse: collapse; font-size: 12.5px; }
.data-table th { background: var(--navy); color: white; padding: 8px 10px; text-align: left; font-weight: 600; font-size: 11.5px; white-space: nowrap; }
.data-table th.new-col { background: var(--green); }
.data-table td { padding: 7px 10px; border-bottom: 1px solid #F0F0F0; vertical-align: top; line-height: 1.4; }
.data-table tr:hover td { background: #F8F9FA; }
.data-table tr.bd-row td { background: var(--bd-bg); }
.data-table tr.dd-row td { background: var(--dd-bg); }
.data-table tr.cp-row td { background: var(--cp-bg); }
.data-table tr.tfe-row td { background: var(--tfe-bg); }
.data-table tr.vl-row td { background: var(--vl-bg); }
.data-table tr.bd-row:hover td { background: #FFF3CC; }
.data-table tr.dd-row:hover td { background: #D6EEF8; }
.data-table tr.cp-row:hover td { background: #DFF0DF; }
.data-table tr.tfe-row:hover td { background: #EDE5F5; }
.data-table tr.vl-row:hover td { background: #FAE0DE; }

/* STATUS BADGES */
.badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; white-space: nowrap; }
.badge-not-started { background: #F5F5F5; color: #757575; border: 1px solid #E0E0E0; }
.badge-in-progress { background: #FFF8E1; color: #F57F17; border: 1px solid #FFE082; }
.badge-completed { background: #E8F5E9; color: #2E7D32; border: 1px solid #A5D6A7; }
.badge-verified { background: #E3F2FD; color: #1565C0; border: 1px solid #90CAF9; }

/* STATUS SELECT */
.status-select { padding: 3px 6px; border: 1px solid var(--border); border-radius: 6px; font-size: 11.5px; cursor: pointer; background: white; }

/* BUTTONS */
.btn { padding: 7px 14px; border-radius: 7px; border: none; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s; }
.btn-primary { background: var(--navy); color: white; }
.btn-primary:hover { background: var(--navy-light); }
.btn-success { background: var(--green); color: white; }
.btn-success:hover { background: var(--green-light); }
.btn-outline { background: white; color: var(--navy); border: 1.5px solid var(--navy); }
.btn-outline:hover { background: var(--navy); color: white; }
.btn-sm { padding: 4px 10px; font-size: 12px; }

/* SECTION HEADERS */
.section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
.section-title { font-size: 16px; font-weight: 700; color: var(--navy); }
.section-sub { font-size: 12px; color: var(--text-muted); margin-top: 2px; }

/* PROGRESS BAR */
.progress-bar { height: 8px; background: #E9ECEF; border-radius: 4px; overflow: hidden; margin-top: 6px; }
.progress-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }

/* TABS within page */
.inner-tabs { display: flex; gap: 4px; margin-bottom: 16px; border-bottom: 2px solid var(--border); padding-bottom: 0; }
.inner-tab { padding: 8px 16px; cursor: pointer; font-size: 13px; font-weight: 500; color: var(--text-muted); border-bottom: 3px solid transparent; margin-bottom: -2px; transition: all 0.2s; }
.inner-tab:hover { color: var(--navy); }
.inner-tab.active { color: var(--navy); border-bottom-color: var(--navy); font-weight: 700; }
.inner-panel { display: none; }
.inner-panel.active { display: block; }

/* CHART CONTAINERS */
.chart-wrap { position: relative; }

/* ALERT / INFO BOXES */
.alert { padding: 10px 14px; border-radius: 8px; font-size: 13px; margin-bottom: 12px; }
.alert-info { background: #E3F2FD; border-left: 4px solid #1565C0; color: #0D47A1; }
.alert-warning { background: #FFF8E1; border-left: 4px solid #F57F17; color: #E65100; }
.alert-success { background: #E8F5E9; border-left: 4px solid #2E7D32; color: #1B5E20; }

/* DEFECT CATEGORY COLORS */
.cat-bd { color: #E67E22; font-weight: 700; }
.cat-dd { color: #2980B9; font-weight: 700; }
.cat-cp { color: #27AE60; font-weight: 700; }
.cat-tfe { color: #8E44AD; font-weight: 700; }
.cat-vl { color: #C0392B; font-weight: 700; }

/* SOLUTION CARDS */
.solution-card { border-radius: 10px; border: 1px solid var(--border); padding: 16px; margin-bottom: 12px; }
.solution-card .sol-header { display: flex; align-items: flex-start; gap: 12px; margin-bottom: 10px; }
.solution-card .sol-icon { font-size: 24px; flex-shrink: 0; }
.solution-card .sol-title { font-size: 14px; font-weight: 700; color: var(--navy); }
.solution-card .sol-meta { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
.solution-card .sol-body { font-size: 13px; line-height: 1.6; color: var(--text); }
.solution-card .sol-tags { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 10px; }
.sol-tag { padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; }
.sol-tag-high { background: #FFEBEE; color: #C62828; }
.sol-tag-med { background: #FFF8E1; color: #E65100; }
.sol-tag-low { background: #E8F5E9; color: #2E7D32; }
.sol-tag-novel { background: #EDE7F6; color: #4527A0; }

/* IMAGE GALLERY */
.img-gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px; }
.img-card { border-radius: 8px; border: 1px solid var(--border); overflow: hidden; background: #1A1A2E; }
.img-card img { width: 100%; height: 200px; object-fit: contain; background: #0D0D1A; }
.img-card .img-caption { padding: 8px 12px; background: white; }
.img-card .img-caption .img-title { font-size: 12px; font-weight: 700; color: var(--navy); }
.img-card .img-caption .img-desc { font-size: 11px; color: var(--text-muted); margin-top: 2px; }

/* TOOLTIP */
[data-tooltip] { position: relative; cursor: help; }
[data-tooltip]:hover::after { content: attr(data-tooltip); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.85); color: white; padding: 5px 10px; border-radius: 6px; font-size: 11px; white-space: nowrap; z-index: 1000; pointer-events: none; }

/* FOOTER */
.footer { text-align: center; padding: 20px; color: var(--text-muted); font-size: 11px; border-top: 1px solid var(--border); margin-top: 20px; }

/* SCROLLABLE TABLE */
.table-scroll { overflow-x: auto; }

/* YIELD EDITOR */
.yield-editor-row { display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--border); }
.yield-editor-row:last-child { border-bottom: none; }
.yield-editor-label { flex: 1; font-size: 13px; font-weight: 600; }
.yield-editor-bar { flex: 2; }
.yield-editor-input-wrap { display: flex; align-items: center; gap: 6px; }
.yield-editor-pct { font-size: 12px; color: var(--text-muted); }

/* WATERFALL CHART CUSTOM */
.waterfall-container { overflow-x: auto; }

/* RESPONSIVE CANVAS */
canvas { max-width: 100%; }

/* HIGHLIGHT */
.highlight { background: #FFF9C4; padding: 1px 4px; border-radius: 3px; }

/* MODAL */
.modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 500; align-items: center; justify-content: center; }
.modal-overlay.open { display: flex; }
.modal { background: white; border-radius: 12px; padding: 24px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
.modal-title { font-size: 16px; font-weight: 700; color: var(--navy); margin-bottom: 16px; }
.modal-close { float: right; cursor: pointer; font-size: 20px; color: var(--text-muted); background: none; border: none; }

/* PRINT */
@media print { .nav { display: none; } .page { display: block !important; } }

    .fa-img-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }
    .fa-img-card {
      background: #fff;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
      transition: transform 0.18s ease, box-shadow 0.18s ease;
    }
    .fa-img-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    }
    .fa-img-title {
      background: linear-gradient(135deg, #1F3864 0%, #2c5282 100%);
      color: #fff;
      font-size: 11.5px;
      font-weight: 600;
      padding: 7px 12px;
      line-height: 1.35;
    }
    .fa-img {
      width: 100%;
      height: auto;
      display: block;
      cursor: zoom-in;
    }
    .fa-images-section-title {
      font-size: 15px;
      font-weight: 700;
      color: #1F3864;
      margin: 24px 0 10px;
      padding-bottom: 6px;
      border-bottom: 2px solid #E9ECEF;
    }


    @keyframes slideIn {
      from { transform: translateX(100px); opacity: 0; }
      to   { transform: translateX(0);     opacity: 1; }
    }
    #editor-modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); z-index: 99997;
      display: none; align-items: center; justify-content: center;
    }
    .editor-modal-box {
      background: #fff; border-radius: 12px; padding: 32px;
      width: 400px; max-width: 95vw; box-shadow: 0 8px 40px rgba(0,0,0,0.3);
    }
    .editor-modal-title {
      font-size: 18px; font-weight: 700; color: #1F3864; margin-bottom: 8px;
    }
    .editor-modal-sub {
      font-size: 13px; color: #666; margin-bottom: 20px; line-height: 1.5;
    }
    .editor-input {
      width: 100%; padding: 10px 12px; border: 1.5px solid #dee2e6;
      border-radius: 6px; font-size: 14px; margin-bottom: 12px;
      box-sizing: border-box;
    }
    .editor-input:focus { outline: none; border-color: #1F3864; }
    #connection-badge {
      display: inline-block; padding: 4px 12px; border-radius: 20px;
      font-size: 11px; font-weight: 600; margin-left: 12px;
      background: #fff3cd; color: #856404;
    }
    .changelog-page { padding: 0; }
    #current-editor-display {
      font-size: 11px; color: rgba(255,255,255,0.75); margin-top: 4px;
    }
</style>
</head>
<body>

<!-- NAVIGATION -->
<nav class="nav"><div style="padding:4px 16px;"><span id="connection-badge">üü° Local mode</span><div id="current-editor-display"></div></div>
  <div class="nav-logo">OLED <span>Yield & FACA</span> Tracker</div>
  <div class="nav-tabs">
    <button class="nav-tab active" onclick="showPage('dashboard')">üìä Dashboard</button>
    <button class="nav-tab" onclick="showPage('yield-editor')">‚úèÔ∏è Yield Editor</button>
    <button class="nav-tab" onclick="showPage('yield-bridge')">üåâ Yield Bridge</button>
    <button class="nav-tab" onclick="showPage('faca-tracker')">üìã FACA Tracker</button>
    <button class="nav-tab" onclick="showPage('defect-detail')">üî¨ Defect Detail</button>
    <button class="nav-tab" onclick="showPage('ai-solutions')">üí° AI Solutions</button>
        <button class="nav-tab" onclick="showPage('changelog')">üìã Change Log</button>
    <button class="nav-tab" onclick="showPage('approval-queue')" id="nav-approval">üîî Approval Queue <span id="pending-badge" style="display:none;background:#C0392B;color:#fff;border-radius:10px;padding:1px 7px;font-size:11px;margin-left:4px;">0</span></button>
    <button class="nav-tab" onclick="showPage('admin-panel')">‚öôÔ∏è Admin</button>
  </div>
  <div class="nav-right"><span class="save-indicator" id="saveIndicator"></span><span id="saveStatus">All changes saved</span></div>
</nav>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- PAGE: DASHBOARD -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page active" id="page-dashboard">
  <div class="section-header">
    <div>
      <div class="section-title">Dashboard ‚Äî Yield & Defect Overview</div>
      <div class="section-sub">Pre-EVT2 &amp; EVT2 Build ¬∑ Goerpixel / Sony ¬∑ Last updated: 2026-02-26</div>
    </div>
    <button class="btn btn-outline btn-sm" onclick="resetToDefaults()">‚Ü∫ Reset to Defaults</button>
  </div>

  <!-- KPI ROW -->
  <div class="grid-5" style="margin-bottom:16px;">
    <div class="kpi-card navy">
      <div class="kpi-label">EVT2 Overall Yield</div>
      <div class="kpi-value" id="kpi-overall">7.00%</div>
      <div class="kpi-sub">Inline Tester (Plan B)</div>
      <div class="kpi-delta up" id="kpi-delta">‚ñ≤ +3.42 pp vs Pre-EVT2</div>
    </div>
    <div class="kpi-card amber">
      <div class="kpi-label">Bright Dot Loss</div>
      <div class="kpi-value" id="kpi-bd">67.41%</div>
      <div class="kpi-sub" id="kpi-bd-qty">1,012 pcs defective</div>
    </div>
    <div class="kpi-card blue">
      <div class="kpi-label">Dark Dot Loss</div>
      <div class="kpi-value" id="kpi-dd">10.57%</div>
      <div class="kpi-sub" id="kpi-dd-qty">207 pcs defective</div>
    </div>
    <div class="kpi-card green">
      <div class="kpi-label">FACA Progress</div>
      <div class="kpi-value" id="kpi-faca">0%</div>
      <div class="kpi-sub" id="kpi-faca-sub">0 / 16 actions completed</div>
    </div>
    <div class="kpi-card purple">
      <div class="kpi-label">Projected Yield (if all CA done)</div>
      <div class="kpi-value" id="kpi-projected">8.64%</div>
      <div class="kpi-sub">Based on CA yield gain estimates</div>
    </div>
  </div>

  <div class="grid-2">
    <!-- Defect Distribution Donut -->
    <div class="card">
      <div class="card-title"><span class="icon">üç©</span> Defect Category Distribution</div>
      <div class="chart-wrap" style="height:280px;">
        <canvas id="chartDefectPie"></canvas>
      </div>
    </div>
    <!-- Yield Trend Bar -->
    <div class="card">
      <div class="card-title"><span class="icon">üìà</span> Yield Comparison ‚Äî Pre-EVT2 vs EVT2</div>
      <div class="chart-wrap" style="height:280px;">
        <canvas id="chartYieldComparison"></canvas>
      </div>
    </div>
  </div>

  <div class="grid-2">
    <!-- FACA Progress by Category -->
    <div class="card">
      <div class="card-title"><span class="icon">‚úÖ</span> FACA Status by Defect Category</div>
      <div id="facaProgressBars"></div>
    </div>
    <!-- Yield Impact Summary -->
    <div class="card">
      <div class="card-title"><span class="icon">üéØ</span> Yield Impact by Corrective Action</div>
      <div class="chart-wrap" style="height:260px;">
        <canvas id="chartYieldImpact"></canvas>
      </div>
    </div>
  </div>

  <!-- Quick Summary Table -->
  <div class="card">
    <div class="card-title"><span class="icon">üìä</span> Defect Summary ‚Äî Quick View</div>
    <div class="table-scroll">
      <table class="data-table" id="summaryTable">
        <thead>
          <tr>
            <th>Category</th>
            <th>Defect Ratio</th>
            <th>Qty (pcs)</th>
            <th>Primary Root Cause</th>
            <th>Key CA</th>
            <th>Expected Gain</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="summaryTableBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- PAGE: YIELD EDITOR -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="page-yield-editor">
  <div class="section-header">
    <div>
      <div class="section-title">‚úèÔ∏è Yield Editor</div>
      <div class="section-sub">Edit baseline yield, defect category contributions, and corrective action gains. All charts update automatically.</div>
    </div>
    <div style="display:flex;gap:8px;">
      <button class="btn btn-outline btn-sm" onclick="resetToDefaults()">‚Ü∫ Reset</button>
      <button class="btn btn-success btn-sm" onclick="saveData()">üíæ Save</button>
    </div>
  </div>

  <div class="alert alert-info">
    <strong>How to use:</strong> Edit any value below and all charts, KPIs, and the yield bridge will update automatically. Changes are saved to your browser's local storage.
  </div>

  <div class="grid-2">
    <!-- Baseline -->
    <div class="card">
      <div class="card-title"><span class="icon">üìç</span> Baseline Yield Settings</div>
      <div class="yield-editor-row">
        <div class="yield-editor-label">Pre-EVT2 Baseline Yield</div>
        <div class="yield-editor-input-wrap">
          <input type="number" class="yield-input" id="input-baseline" value="3.58" min="0" max="100" step="0.01" onchange="updateAll()">
          <span class="yield-editor-pct">%</span>
        </div>
      </div>
      <div class="yield-editor-row">
        <div class="yield-editor-label">EVT2 Actual Yield (Plan B)</div>
        <div class="yield-editor-input-wrap">
          <input type="number" class="yield-input" id="input-actual" value="7.00" min="0" max="100" step="0.01" onchange="updateAll()">
          <span class="yield-editor-pct">%</span>
        </div>
      </div>
      <div class="yield-editor-row">
        <div class="yield-editor-label">EVT2 Target Yield (POR)</div>
        <div class="yield-editor-input-wrap">
          <input type="number" class="yield-input" id="input-target" value="10.00" min="0" max="100" step="0.01" onchange="updateAll()">
          <span class="yield-editor-pct">%</span>
        </div>
      </div>
    </div>

    <!-- Defect Category Ratios -->
    <div class="card">
      <div class="card-title"><span class="icon">üî¢</span> Defect Category Ratios (% of total defects)</div>
      <div id="defectRatioEditor"></div>
    </div>
  </div>

  <!-- CA Yield Gain Editor -->
  <div class="card">
    <div class="card-title"><span class="icon">üéØ</span> Corrective Action ‚Äî Expected Yield Gain Editor</div>
    <div class="alert alert-warning" style="margin-bottom:12px;">
      These values represent the estimated absolute yield gain (in percentage points) from each corrective action. The Yield Bridge chart is built from these values.
    </div>
    <div class="table-scroll">
      <table class="data-table">
        <thead>
          <tr>
            <th>Corrective Action</th>
            <th>Category</th>
            <th>Expected Yield Gain (pp)</th>
            <th>Status</th>
            <th>Realized Gain</th>
          </tr>
        </thead>
        <tbody id="caGainEditor"></tbody>
      </table>
    </div>
  </div>

  <!-- Live Preview -->
  <div class="card">
    <div class="card-title"><span class="icon">üëÅÔ∏è</span> Live Yield Summary Preview</div>
    <div class="grid-4" id="livePreview"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- PAGE: YIELD BRIDGE -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="page-yield-bridge">
  <div class="section-header">
    <div>
      <div class="section-title">üåâ Yield Bridge</div>
      <div class="section-sub">Waterfall chart showing yield gain from each corrective action. Completed actions shown in solid color; pending in lighter shade.</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center;">
      <label style="font-size:12px;color:var(--text-muted);">Show only completed:</label>
      <input type="checkbox" id="showOnlyCompleted" onchange="renderYieldBridge()">
    </div>
  </div>

  <div class="card">
    <div class="chart-wrap waterfall-container" style="height:420px;">
      <canvas id="chartYieldBridge"></canvas>
    </div>
  </div>

  <div class="grid-2">
    <div class="card">
      <div class="card-title"><span class="icon">üìä</span> Yield Bridge ‚Äî Detailed Table</div>
      <div class="table-scroll">
        <table class="data-table" id="bridgeTable">
          <thead>
            <tr>
              <th>Step</th>
              <th>Corrective Action</th>
              <th>Category</th>
              <th>Expected Gain (pp)</th>
              <th>Cumulative Yield</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="bridgeTableBody"></tbody>
        </table>
      </div>
    </div>
    <div class="card">
      <div class="card-title"><span class="icon">üéØ</span> Yield Gap Analysis</div>
      <div id="yieldGapAnalysis"></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- PAGE: FACA TRACKER -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="page-faca-tracker">
  <div class="section-header">
    <div>
      <div class="section-title">üìã FACA Tracker</div>
      <div class="section-sub">Track corrective action status per defect mode. Update status to reflect progress ‚Äî yield bridge updates automatically.</div>
    </div>
    <div style="display:flex;gap:8px;">
      <select id="filterCategory" class="status-select" onchange="renderFACATable()">
        <option value="all">All Categories</option>
        <option value="BD">Bright Dot</option>
        <option value="DD">Dark Dot</option>
        <option value="CP">CP NG</option>
        <option value="TFE">TFE AOI NG</option>
        <option value="VL">V-Line</option>
      </select>
      <select id="filterStatus" class="status-select" onchange="renderFACATable()">
        <option value="all">All Statuses</option>
        <option value="Not Started">Not Started</option>
        <option value="In Progress">In Progress</option>
        <option value="Completed">Completed</option>
        <option value="Verified">Verified</option>
      </select>
    </div>
  </div>

  <!-- Progress Overview -->
  <div class="grid-4" style="margin-bottom:16px;" id="facaKpiCards"></div>

  <div class="card">
    <div class="card-title"><span class="icon">üìã</span> Corrective Action Register</div>
    <div class="table-scroll">
      <table class="data-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Category</th>
            <th>Defect Mode</th>
            <th>Corrective Action</th>
            <th>Checkpoint</th>
            <th class="new-col">Expected Yield Gain</th>
            <th class="new-col">Status</th>
            <th class="new-col">Notes</th>
          </tr>
        </thead>
        <tbody id="facaTableBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- PAGE: DEFECT DETAIL -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="page-defect-detail">
  <div class="section-title" style="margin-bottom:16px;">üî¨ Defect Detail ‚Äî FA Analysis</div>
  <div class="inner-tabs">
    <div class="inner-tab active" onclick="showInnerTab('dd-bd')">üü° Bright Dot</div>
    <div class="inner-tab" onclick="showInnerTab('dd-dd')">üîµ Dark Dot</div>
    <div class="inner-tab" onclick="showInnerTab('dd-cp')">üü¢ CP NG</div>
    <div class="inner-tab" onclick="showInnerTab('dd-tfe')">üü£ TFE AOI NG</div>
    <div class="inner-tab" onclick="showInnerTab('dd-vl')">üî¥ V-Line</div>
  </div>

  <!-- BD Panel -->
  <div class="inner-panel active" id="panel-dd-bd">
    <div class="grid-2" style="margin-bottom:16px;">
      <div class="kpi-card amber">
        <div class="kpi-label">Bright Dot ‚Äî Total Defect Ratio</div>
        <div class="kpi-value" id="bd-ratio-display">67.41%</div>
        <div class="kpi-sub">1,012 pcs | #1 yield detractor</div>
      </div>
      <div class="kpi-card navy">
        <div class="kpi-label">BD Type Split</div>
        <div class="kpi-value">FE: 59.1% | BP: 40.9%</div>
        <div class="kpi-sub">FE = Front-End OLED process | BP = Backplane IC</div>
      </div>
    </div>
    <div class="card">
      <div class="card-title"><span class="icon">üìä</span> Bright Dot ‚Äî Defect Mode Breakdown</div>
      <div class="grid-2">
        <div class="chart-wrap" style="height:260px;"><canvas id="chartBDTypes"></canvas></div>
        <div class="table-scroll">
          <table class="data-table">
            <thead><tr><th>Type</th><th>Root Cause</th><th>Ratio</th><th>Phenomenon</th></tr></thead>
            <tbody>
              <tr class="bd-row"><td><strong>Type 1 (FE)</strong></td><td>Cathode & CGL leakage</td><td>Part of 59.1%</td><td>BD in AM & PM mode; green/yellow; low contrast; dynamic</td></tr>
              <tr class="bd-row"><td><strong>Type 2 (FE)</strong></td><td>Cathode & CGL short by P/T on PDL footer</td><td>Part of 59.1%</td><td>BD in AM & PM mode; green/yellow; strong bright dot</td></tr>
              <tr class="bd-row"><td><strong>Type 3 (FE)</strong></td><td>Anode & CGL leakage (ITO particles)</td><td>Part of 59.1%</td><td>BD in AM & PM mode; blue; small portion</td></tr>
              <tr class="bd-row"><td><strong>Type 4 (BP)</strong></td><td>BP Ioff variation</td><td>40.9%</td><td>BD in AM mode only; green/white; higher contrast at low GL</td></tr>
              <tr class="bd-row"><td><strong>Type 5 (BP)</strong></td><td>TD short [Hypothesis]</td><td>Very small</td><td>BD in AM mode only; very high brightness</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-title"><span class="icon">üî¨</span> Key FA Images ‚Äî Bright Dot</div>
      <div class="alert alert-info">These are representative FA images from the Sony/Goerpixel EVT2 failure analysis report (2026-02-26). Images show cross-sections, EDS maps, and optical micrographs of BD defect sites.</div>
      <div class="img-gallery">
<div class="img-card" style="cursor:zoom-in;" onclick="openFALightbox('https://files.manuscdn.com/user_upload_by_module/session_file/310519663388950090/DhwDMWoZBzHLioow.jpg','BD Type 1 ‚Äî CGL/Cathode Shunt SEM Cross-Section & ETL Mitigation')">
          <div class="img-card-label">Slide 7: BD Type 1 ‚Äî CGL/Cathode Shunt SEM Cross-Section & ETL Mitigation</div>
          <img src="https://files.manuscdn.com/user_upload_by_module/session_file/310519663388950090/ykWKNYQajBsBmXxo.jpg" alt="BD Type 1 ‚Äî CGL/Cathode Shunt SEM Cross-Section & ETL Mitigation" style="width:100%;height:auto;display:block;" loading="lazy">
        </div>
<div class="img-card" style="cursor:zoom-in;" onclick="openFALightbox('https://files.manuscdn.com/user_upload_by_module/session_file/310519663388950090/JoAaWXCYHtmsIFmz.jpg','BD Type 2 ‚Äî Ti/OLED Particle Detected in Bright Dot Pixel (SEM)')">
          <div class="img-card-label">Slide 8: BD Type 2 ‚Äî Ti/OLED Particle Detected in Bright Dot Pixel (SEM)</div>
          <img src="https://files.manuscdn.com/user_upload_by_module/session_file/310519663388950090/wJoTrqROTfsrCIzQ.jpg" alt="BD Type 2 ‚Äî Ti/OLED Particle Detected in Bright Dot Pixel (SEM)" style="width:100%;height:auto;display:block;" loading="lazy">
        </div>
<div class="img-card" style="cursor:zoom-in;" onclick="openFALightbox('https://files.manuscdn.com/user_upload_by_module/session_file/310519663388950090/sdZSVSalxKqFviva.jpg','BD Type 3 ‚Äî ITO Particle SEM Cross-Section & EDS Maps (O, In)')">
          <div class="img-card-label">Slide 9: BD Type 3 ‚Äî ITO Particle SEM Cross-Section & EDS Maps (O, In)</div>
          <img src="https://files.manuscdn.com/user_upload_by_module/session_file/310519663388950090/ERxzCCZLsjHdppVV.jpg" alt="BD Type 3 ‚Äî ITO Particle SEM Cross-Section & EDS Maps (O, In)" style="width:100%;height:auto;display:block;" loading="lazy">
        </div>
<div class="img-card" style="cursor:zoom-in;" onclick="openFALightbox('https://files.manuscdn.com/user_upload_by_module/session_file/310519663388950090/MFyYVtpwXTWPIoVj.jpg','BD Type 4 ‚Äî BP Backplane Ioff Related Bright Dot')">
          <div class="img-card-label">Slide 10: BD Type 4 ‚Äî BP Backplane Ioff Related Bright Dot</div>
          <img src="https://files.manuscdn.com/user_upload_by_module/session_file/310519663388950090/lfACXLAnulRqvKwY.jpg" alt="BD Type 4 ‚Äî BP Backplane Ioff Related Bright Dot" style="width:100%;height:auto;display:block;" loading="lazy">
        </div>
<div class="img-card" style="cursor:zoom-in;" onclick="openFALightbox('https://files.manuscdn.com/user_upload_by_module/session_file/310519663388950090/FtNIkijocgchuJnM.jpg','BD Type 5 ‚Äî High Brightness BD: Driver MOS & TD Short SEM')">
          <div class="img-card-label">Slide 11: BD Type 5 ‚Äî High Brightness BD: Driver MOS & TD Short SEM</div>
          <img src="https://files.manuscdn.com/user_upload_by_module/session_file/310519663388950090/fFeXUPQhqHbYFyFH.jpg" alt="BD Type 5 ‚Äî High Brightness BD: Driver MOS & TD Short SEM" style="width:100%;height:auto;display:block;" loading="lazy">
        </div>
</div>
    </div>
  
  <div class="fa-images-section-title">üì∏ FA Images</div>
  <div class="fa-img-grid" id="imgs-panel-dd-bd">
    <div style="color:#888;font-style:italic;padding:16px 0;">Loading FA images...</div>
  </div>

  <div style="text-align:center;margin:24px 0;">
    <button onclick="saveYieldToSheets()"
            style="padding:12px 32px;background:#1F3864;color:#fff;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,0.15);">
      üíæ Save Yield Data to Google Sheets
    </button>
    <div style="font-size:11px;color:#888;margin-top:8px;">Changes are also auto-saved locally in your browser</div>
  </div>
</div>

  <!-- DD Panel -->
  <div class="inner-panel" id="panel-dd-dd">
    <div class="grid-2" style="margin-bottom:16px;">
      <div class="kpi-card blue">
        <div class="kpi-label">Dark Dot ‚Äî Total Defect Ratio</div>
        <div class="kpi-value" id="dd-ratio-display">10.57%</div>
        <div class="kpi-sub">207 pcs | #2 yield detractor</div>
      </div>
      <div class="kpi-card navy">
        <div class="kpi-label">DD FA Results</div>
        <div class="kpi-value">11 pcs analyzed</div>
        <div class="kpi-sub">FE-related: ~95% | BP-related: ~5%</div>
      </div>
    </div>
    <div class="card">
      <div class="card-title"><span class="icon">üìä</span> Dark Dot ‚Äî Defect Mode Breakdown</div>
      <div class="grid-2">
        <div class="chart-wrap" style="height:260px;"><canvas id="chartDDTypes"></canvas></div>
        <div class="table-scroll">
          <table class="data-table">
            <thead><tr><th>Type</th><th>Root Cause</th><th>Analyzed</th><th>Ratio</th></tr></thead>
            <tbody>
              <tr class="dd-row"><td><strong>Type 2</strong></td><td>Anode & Cathode short (C/In/Zn particle)</td><td>3/11</td><td>27.3%</td></tr>
              <tr class="dd-row"><td><strong>Type 3</strong></td><td>P/T in OLED or residue on Anode (PDL residue)</td><td>2/11</td><td>18.1%</td></tr>
              <tr class="dd-row"><td><strong>Type 4</strong></td><td>In-film particle (CF/OC/MLA/OCR)</td><td>3/11</td><td>27.3%</td></tr>
              <tr class="dd-row"><td><strong>No abn. FE</strong></td><td>VIA/anode open [hypothesis]</td><td>2/11</td><td>18.2%</td></tr>
              <tr class="dd-row"><td><strong>No abn. BP</strong></td><td>BP-related (unknown)</td><td>1/11</td><td>9.1%</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-title"><span class="icon">üî¨</span> Key FA Images ‚Äî Dark Dot</div>
      <div class="img-gallery">
<div class="img-card" style="cursor:zoom-in;" onclick="openFALightbox('https://files.manuscdn.com/user_upload_by_module/session_file/310519663388950090/ngtlegDtbPbOJbwh.jpg','DD Inspection ‚Äî Optical Microscopy (5 samples) & Wafer/Die Mapping')">
          <div class="img-card-label">Slide 18: DD Inspection ‚Äî Optical Microscopy (5 samples) & Wafer/Die Mapping</div>
          <img src="https://files.manuscdn.com/user_upload_by_module/session_file/310519663388950090/ujJzBbZtffALEcfX.jpg" alt="DD Inspection ‚Äî Optical Microscopy (5 samples) & Wafer/Die Mapping" style="width:100%;height:auto;display:block;" loading="lazy">
        </div>
<div class="img-card" style="cursor:zoom-in;" onclick="openFALightbox('https://files.manuscdn.com/user_upload_by_module/session_file/310519663388950090/ibsfPbzaCiCwZAQn.jpg','DD Type 1 ‚Äî No FA Abnormal; VIA/Anode Open Hypothesis (FIB/SEM)')">
          <div class="img-card-label">Slide 21: DD Type 1 ‚Äî No FA Abnormal; VIA/Anode Open Hypothesis (FIB/SEM)</div>
          <img src="https://files.manuscdn.com/user_upload_by_module/session_file/310519663388950090/UvYpnAvdYBvoCJRj.jpg" alt="DD Type 1 ‚Äî No FA Abnormal; VIA/Anode Open Hypothesis (FIB/SEM)" style="width:100%;height:auto;display:block;" loading="lazy">
        </div>
<div class="img-card" style="cursor:zoom-in;" onclick="openFALightbox('https://files.manuscdn.com/user_upload_by_module/session_file/310519663388950090/QvEeVZlAyvmNToCQ.jpg','DD Type 2 ‚Äî Anode/Cathode Short FIB/SEM & EDS Maps (C/In/Zn)')">
          <div class="img-card-label">Slide 22: DD Type 2 ‚Äî Anode/Cathode Short FIB/SEM & EDS Maps (C/In/Zn)</div>
          <img src="https://files.manuscdn.com/user_upload_by_module/session_file/310519663388950090/WnKxJEAzKMCyVpsb.jpg" alt="DD Type 2 ‚Äî Anode/Cathode Short FIB/SEM & EDS Maps (C/In/Zn)" style="width:100%;height:auto;display:block;" loading="lazy">
        </div>
<div class="img-card" style="cursor:zoom-in;" onclick="openFALightbox('https://files.manuscdn.com/user_upload_by_module/session_file/310519663388950090/yVjQTkPOkVKJUPni.jpg','DD Type 3 ‚Äî PDL Residue Conductive Particle FIB/SEM')">
          <div class="img-card-label">Slide 23: DD Type 3 ‚Äî PDL Residue Conductive Particle FIB/SEM</div>
          <img src="https://files.manuscdn.com/user_upload_by_module/session_file/310519663388950090/UKBRDIplsjhFOCRq.jpg" alt="DD Type 3 ‚Äî PDL Residue Conductive Particle FIB/SEM" style="width:100%;height:auto;display:block;" loading="lazy">
        </div>
<div class="img-card" style="cursor:zoom-in;" onclick="openFALightbox('https://files.manuscdn.com/user_upload_by_module/session_file/310519663388950090/pkbYhGQaqJDKFcQm.jpg','DD Type 4 ‚Äî In-Film Particle CF/OC/MLA/OCR FIB Cross-Sections')">
          <div class="img-card-label">Slide 24: DD Type 4 ‚Äî In-Film Particle CF/OC/MLA/OCR FIB Cross-Sections</div>
          <img src="https://files.manuscdn.com/user_upload_by_module/session_file/310519663388950090/mLKtSAecuhDzsaes.jpg" alt="DD Type 4 ‚Äî In-Film Particle CF/OC/MLA/OCR FIB Cross-Sections" style="width:100%;height:auto;display:block;" loading="lazy">
        </div>
</div>
    </div>
  
  <div class="fa-images-section-title">üì∏ FA Images</div>
  <div class="fa-img-grid" id="imgs-panel-dd-dd">
    <div style="color:#888;font-style:italic;padding:16px 0;">Loading FA images...</div>
  </div>
</div>

  <!-- CP Panel -->
  <div class="inner-panel" id="panel-dd-cp">
    <div class="kpi-card green" style="margin-bottom:16px;">
      <div class="kpi-label">CP NG ‚Äî Total Defect Ratio</div>
      <div class="kpi-value" id="cp-ratio-display">5.56%</div>
      <div class="kpi-sub">327 pcs | #3 yield detractor</div>
    </div>
    <div class="card">
      <div class="card-title"><span class="icon">üìä</span> CP NG ‚Äî Mode Breakdown</div>
      <div class="grid-2">
        <div class="chart-wrap" style="height:260px;"><canvas id="chartCPTypes"></canvas></div>
        <div class="table-scroll">
          <table class="data-table">
            <thead><tr><th>Mode</th><th>Ratio</th><th>Phenomenon</th><th>CA Status</th></tr></thead>
            <tbody>
              <tr class="cp-row"><td><strong>Leakage (Static IDD)</strong></td><td>84.5%</td><td>Static IDD fail</td><td><span class="badge badge-in-progress">In Progress</span></td></tr>
              <tr class="cp-row"><td><strong>Short (Power)</strong></td><td>11.3%</td><td>Power short</td><td><span class="badge badge-in-progress">In Progress</span></td></tr>
              <tr class="cp-row"><td><strong>GOA circuit</strong></td><td>4.2%</td><td>GOA function fail</td><td><span class="badge badge-not-started">Not Started</span></td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="alert alert-warning">EFA/PFA for CP NG leakage and short modes is scheduled for completion by <strong>2026-03-05</strong>. Results will determine root cause and corrective action plan.</div>
  </div>

  <!-- TFE Panel -->
  <div class="inner-panel" id="panel-dd-tfe">
    <div class="kpi-card purple" style="margin-bottom:16px;">
      <div class="kpi-label">TFE AOI NG ‚Äî Total Defect Ratio</div>
      <div class="kpi-value" id="tfe-ratio-display">4.50%</div>
      <div class="kpi-sub">263 pcs | #4 yield detractor</div>
    </div>
    <div class="card">
      <div class="card-title"><span class="icon">üìä</span> TFE AOI NG ‚Äî Analysis</div>
      <div class="alert alert-info">TFE AOI NG is primarily FE-related particle out of spec. Some overkill was observed at early stage. Three corrective actions are in parallel: EL mask update, particle reduction, and AOI algorithm optimization.</div>
      <table class="data-table">
        <thead><tr><th>CA Item</th><th>Description</th><th>Checkpoint</th><th>Expected Outcome</th></tr></thead>
        <tbody>
          <tr class="tfe-row"><td>‚ë† EL Mask Update</td><td>EVT2 B+3 POR2 build with updated EL mask design</td><td>EVT2 (B+3) POR2 build</td><td>Reduce particle exposure area</td></tr>
          <tr class="tfe-row"><td>‚ë° Particle Reduction</td><td>Random particle reduction via EV/EN high operation rate</td><td>Ongoing monitoring</td><td>Lower particle count at TFE AOI</td></tr>
          <tr class="tfe-row"><td>‚ë¢ AOI Algorithm</td><td>AOI algorithm optimization for CT/AMT correlation</td><td>Overkill rate vs. CT/AMT check</td><td>Reduce overkill; stable yield</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- VL Panel -->
  <div class="inner-panel" id="panel-dd-vl">
    <div class="kpi-card red" style="margin-bottom:16px;">
      <div class="kpi-label">V-Line Display ‚Äî Total Defect Ratio</div>
      <div class="kpi-value" id="vl-ratio-display">3.22%</div>
      <div class="kpi-sub">56 pcs | #5 yield detractor</div>
    </div>
    <div class="card">
      <div class="card-title"><span class="icon">üìä</span> V-Line ‚Äî Mode Breakdown</div>
      <div class="grid-2">
        <div class="chart-wrap" style="height:260px;"><canvas id="chartVLTypes"></canvas></div>
        <div class="table-scroll">
          <table class="data-table">
            <thead><tr><th>Mode</th><th>Analyzed</th><th>Ratio</th><th>Root Cause</th></tr></thead>
            <tbody>
              <tr class="vl-row"><td><strong>BP CT Crosstalk</strong></td><td>9/56</td><td>16.1%</td><td>CT: multi/single bright & dark line; crosstalk</td></tr>
              <tr class="vl-row"><td><strong>Bonding Resistance</strong></td><td>47/56</td><td>83.9%</td><td>Over-pressed ACF particles; module bonding related</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-title"><span class="icon">üî¨</span> Key FA Images ‚Äî V-Line / Bonding</div>
      <div class="img-gallery">
<div class="img-card" style="cursor:zoom-in;" onclick="openFALightbox('https://files.manuscdn.com/user_upload_by_module/session_file/310519663388950090/xDYYSCmWZSFQGcQL.jpg','V-Line Phenomenon ‚Äî Single/Multi Bright/Dark Lines & ACF Over-Pressed SEM')">
          <div class="img-card-label">Slide 31: V-Line Phenomenon ‚Äî Single/Multi Bright/Dark Lines & ACF Over-Pressed SEM</div>
          <img src="https://files.manuscdn.com/user_upload_by_module/session_file/310519663388950090/qPMQxVpnOzVexRaC.jpg" alt="V-Line Phenomenon ‚Äî Single/Multi Bright/Dark Lines & ACF Over-Pressed SEM" style="width:100%;height:auto;display:block;" loading="lazy">
        </div>
<div class="img-card" style="cursor:zoom-in;" onclick="openFALightbox('https://files.manuscdn.com/user_upload_by_module/session_file/310519663388950090/geCMUDmeZkUMHRbs.jpg','V-Line Root Cause Analysis ‚Äî Bonding Process Investigation')">
          <div class="img-card-label">Slide 32: V-Line Root Cause Analysis ‚Äî Bonding Process Investigation</div>
          <img src="https://files.manuscdn.com/user_upload_by_module/session_file/310519663388950090/yhhERwUCNaDEpWGU.jpg" alt="V-Line Root Cause Analysis ‚Äî Bonding Process Investigation" style="width:100%;height:auto;display:block;" loading="lazy">
        </div>
<div class="img-card" style="cursor:zoom-in;" onclick="openFALightbox('https://files.manuscdn.com/user_upload_by_module/session_file/310519663388950090/gAPhPjlolJyQPjct.jpg','LDO FPC Split-Screen FA ‚Äî ELVDD/VGH1 Micro-Short Circuit')">
          <div class="img-card-label">Slide 34: LDO FPC Split-Screen FA ‚Äî ELVDD/VGH1 Micro-Short Circuit</div>
          <img src="https://files.manuscdn.com/user_upload_by_module/session_file/310519663388950090/AypmQpHOZOXsXlUK.jpg" alt="LDO FPC Split-Screen FA ‚Äî ELVDD/VGH1 Micro-Short Circuit" style="width:100%;height:auto;display:block;" loading="lazy">
        </div>
</div>
    </div>
  
  <div class="fa-images-section-title">üì∏ FA Images</div>
  <div class="fa-img-grid" id="imgs-panel-dd-vl">
    <div style="color:#888;font-style:italic;padding:16px 0;">Loading FA images...</div>
  </div>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- PAGE: AI SOLUTIONS -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="page-ai-solutions">
  <div class="section-header">
    <div>
      <div class="section-title">üí° AI-Suggested Solutions ‚Äî Beyond Current Plan</div>
      <div class="section-sub">Based on external research into OLED manufacturing literature, patents, and industry best practices. These are solutions that Goerpixel/Sony may not have included in the current corrective action plan.</div>
    </div>
  </div>

  <div class="alert alert-warning">
    <strong>Disclaimer:</strong> These suggestions are based on published academic research, industry patents, and manufacturing best practices. They require engineering evaluation before implementation. Potential yield gains are estimates based on literature data.
  </div>

  <div class="inner-tabs">
    <div class="inner-tab active" onclick="showInnerTab('sol-particle')">üßπ Particle Control</div>
    <div class="inner-tab" onclick="showInnerTab('sol-pdl')">üìê PDL / Cathode</div>
    <div class="inner-tab" onclick="showInnerTab('sol-bp')">‚ö° Backplane (BP)</div>
    <div class="inner-tab" onclick="showInnerTab('sol-aoi')">üëÅÔ∏è AOI / Inspection</div>
    <div class="inner-tab" onclick="showInnerTab('sol-bonding')">üîó Bonding</div>
    <div class="inner-tab" onclick="showInnerTab('sol-novel')">üöÄ Novel / Emerging</div>
  </div>

  <div class="inner-panel active" id="panel-sol-particle">
    <div class="solution-card" style="border-left:4px solid var(--amber);">
      <div class="sol-header">
        <div class="sol-icon">üîß</div>
        <div>
          <div class="sol-title">Effusion Cell Redesign for Cathode Deposition (Veeco-type)</div>
          <div class="sol-meta">Addresses: BD Type 2 (Ti particle) ¬∑ DD Type 2 (conductive particle) ¬∑ Estimated gain: 15‚Äì25% reduction in particle-related BDs</div>
        </div>
      </div>
      <div class="sol-body">
        Standard MBE-derived effusion cells used in OLED cathode deposition generate particles via condensation on cooler crucible surfaces and orifice inserts. Research by Veeco Instruments demonstrates that a redesigned heater assembly with optimized crucible geometry ‚Äî eliminating the reduced-diameter orifice insert ‚Äî significantly reduces particle generation. The key mechanism is preventing material condensation at the crucible orifice, which is the primary particle source. Goerpixel's current plan addresses Ti particles from the PDL process but does not appear to address particle generation from the cathode evaporation source itself. Evaluating alternative evaporation source vendors or redesigning the crucible configuration could reduce cathode-layer particle defects by 15‚Äì25%.
      </div>
      <div class="sol-tags">
        <span class="sol-tag sol-tag-high">High Impact</span>
        <span class="sol-tag sol-tag-med">Medium Effort</span>
        <span class="sol-tag sol-tag-novel">Not in Current Plan</span>
      </div>
    </div>

    <div class="solution-card" style="border-left:4px solid var(--amber);">
      <div class="sol-header">
        <div class="sol-icon">üì°</div>
        <div>
          <div class="sol-title">In-Situ Real-Time Particle Monitoring in N‚ÇÇ Box</div>
          <div class="sol-meta">Addresses: All particle-related defects (BD Type 1/2/3, DD Type 2/3/4) ¬∑ Estimated gain: Early detection prevents 5‚Äì10% of particle-related yield loss</div>
        </div>
      </div>
      <div class="sol-body">
        The current plan relies on post-process particle counting (e.g., Ti particle count post-PDL). However, real-time particle monitoring inside the N‚ÇÇ enclosure during OLED deposition is not standard practice at most fabs. Installing in-situ particle counters at key deposition chambers enables immediate feedback ‚Äî if particle counts exceed threshold during a run, the panel can be flagged before committing to downstream processes. This is analogous to semiconductor fabs where in-situ monitoring is standard. The high isolation requirements of the N‚ÇÇ box present challenges (traditional cleanroom monitors cannot be used), but specialized OLED N‚ÇÇ box monitoring solutions are commercially available (e.g., PMeasuring OLED N‚ÇÇ Box Monitoring).
      </div>
      <div class="sol-tags">
        <span class="sol-tag sol-tag-high">High Impact</span>
        <span class="sol-tag sol-tag-low">Low Effort</span>
        <span class="sol-tag sol-tag-novel">Not in Current Plan</span>
      </div>
    </div>

    <div class="solution-card" style="border-left:4px solid var(--amber);">
      <div class="sol-header">
        <div class="sol-icon">üîç</div>
        <div>
          <div class="sol-title">Backside Film Contamination Inspection Before CF/OC Coating</div>
          <div class="sol-meta">Addresses: DD Type 4 (in-film particle in CF/OC/MLA) ¬∑ Estimated gain: 10‚Äì15% reduction in in-film particle DDs</div>
        </div>
      </div>
      <div class="sol-body">
        EU OLED contamination research (CORDIS project) identified that film backside contamination ‚Äî not visible to standard front-side AOI ‚Äî is a major source of in-film particles that later manifest as dark dots in CF, OC, and MLA layers. The current plan does not include backside inspection before CF/OC coating. Adding a backside particle inspection step (using dark-field illumination or laser scattering) before each coating step would catch contamination events before they are buried under subsequent layers, where they become impossible to remove without destroying the panel.
      </div>
      <div class="sol-tags">
        <span class="sol-tag sol-tag-med">Medium Impact</span>
        <span class="sol-tag sol-tag-low">Low Effort</span>
        <span class="sol-tag sol-tag-novel">Not in Current Plan</span>
      </div>
    </div>

    <div class="solution-card" style="border-left:4px solid var(--amber);">
      <div class="sol-header">
        <div class="sol-icon">üí®</div>
        <div>
          <div class="sol-title">Vacuum Break Particle Monitoring (RGA + Particle Counter)</div>
          <div class="sol-meta">Addresses: All particle defects ¬∑ Estimated gain: Identifies contamination events that cause yield excursions</div>
        </div>
      </div>
      <div class="sol-body">
        Particles generated during vacuum chamber venting and pumping cycles are a known but often unmonitored contamination source in OLED manufacturing. During vacuum breaks for maintenance or material loading, particles can be introduced into the chamber and deposit on subsequent panels. Installing residual gas analyzers (RGA) combined with particle counters at vacuum break points enables identification of contamination events before panels are processed. This is a preventive measure that can explain yield excursions that are otherwise attributed to process variation.
      </div>
      <div class="sol-tags">
        <span class="sol-tag sol-tag-med">Medium Impact</span>
        <span class="sol-tag sol-tag-low">Low Effort</span>
        <span class="sol-tag sol-tag-novel">Not in Current Plan</span>
      </div>
    </div>
  </div>

  <div class="inner-panel" id="panel-sol-pdl">
    <div class="solution-card" style="border-left:4px solid var(--blue);">
      <div class="sol-header">
        <div class="sol-icon">üìê</div>
        <div>
          <div class="sol-title">Undercut PDL (Negative-Taper) Geometry</div>
          <div class="sol-meta">Addresses: BD Type 2 (cathode-anode short via PDL footer) ¬∑ Estimated gain: 20‚Äì30% reduction in PDL-related BD shorts</div>
        </div>
      </div>
      <div class="sol-body">
        A negative-taper (undercut) PDL profile creates a natural shadow mask effect that prevents cathode metal from continuously bridging the anode edge. This is a well-established technique used in Samsung and LG OLED fabs (documented in multiple patents and the 2025 SSRN review on OLED organic materials). The undercut geometry ensures that the cathode deposited by thermal evaporation cannot form a continuous conductive path from the pixel interior to the PDL footer, eliminating the Type 2 BD mechanism. The current Goerpixel plan uses a cathode ring redesign and SiO retention ‚Äî but does not appear to include a fundamental PDL geometry change to undercut profile, which would provide a more robust structural solution.
      </div>
      <div class="sol-tags">
        <span class="sol-tag sol-tag-high">High Impact</span>
        <span class="sol-tag sol-tag-med">Medium Effort</span>
        <span class="sol-tag sol-tag-novel">Not in Current Plan</span>
      </div>
    </div>

    <div class="solution-card" style="border-left:4px solid var(--blue);">
      <div class="sol-header">
        <div class="sol-icon">‚¨õ</div>
        <div>
          <div class="sol-title">Black PDL (BPDL) ‚Äî Dual Function: Isolation + Contrast</div>
          <div class="sol-meta">Addresses: BD Type 2 (PDL-related shorts) + display contrast improvement ¬∑ Estimated gain: 10‚Äì15% BD reduction + contrast ratio improvement</div>
        </div>
      </div>
      <div class="sol-body">
        Replacing standard PDL with black PDL (BPDL) provides two simultaneous benefits: improved electrical isolation between cathode and anode at the pixel edge (reducing Type 2 BDs), and improved display contrast ratio by absorbing ambient light at the pixel boundary. BPDL is documented in the 2025 OLED organic materials review (SSRN) as a key advancement in AMOLED manufacturing. The black pigment in BPDL also helps mask minor particle contamination at the PDL edge that would otherwise cause visible defects. This is a process-compatible upgrade that does not require fundamental changes to the deposition sequence.
      </div>
      <div class="sol-tags">
        <span class="sol-tag sol-tag-med">Medium Impact</span>
        <span class="sol-tag sol-tag-med">Medium Effort</span>
        <span class="sol-tag sol-tag-novel">Not in Current Plan</span>
      </div>
    </div>

    <div class="solution-card" style="border-left:4px solid var(--blue);">
      <div class="sol-header">
        <div class="sol-icon">üìè</div>
        <div>
          <div class="sol-title">Systematic Anode-PDL Overlap CD Monitoring</div>
          <div class="sol-meta">Addresses: BD Type 2/3 (anode edge exposure) ¬∑ Estimated gain: Prevents process drift that causes yield excursions</div>
        </div>
      </div>
      <div class="sol-body">
        Research published in SID Journal (2022) demonstrates that deviation of anode pattern critical dimension (CD) primarily affects the overlap of anode and PDL, directly causing cathode-anode short defects when the PDL opening extends beyond the anode edge. The current plan focuses on mask redesign but does not include systematic CD measurement of anode-PDL overlap at multiple points per panel as a process control step. Implementing SPC (Statistical Process Control) on anode-PDL overlap CD would catch process drift before it causes yield excursions, providing a preventive rather than reactive control mechanism.
      </div>
      <div class="sol-tags">
        <span class="sol-tag sol-tag-med">Medium Impact</span>
        <span class="sol-tag sol-tag-low">Low Effort</span>
        <span class="sol-tag sol-tag-novel">Not in Current Plan</span>
      </div>
    </div>
  </div>

  <div class="inner-panel" id="panel-sol-bp">
    <div class="solution-card" style="border-left:4px solid var(--green);">
      <div class="sol-header">
        <div class="sol-icon">‚ö°</div>
        <div>
          <div class="sol-title">LTPO Hybrid Backplane (LTPS + IGZO) for Ultra-Low Ioff</div>
          <div class="sol-meta">Addresses: BD Type 4 (BP Ioff variation) ¬∑ Estimated gain: Near-elimination of BP-type BDs (Ioff reduced from nA to sub-pA range)</div>
        </div>
      </div>
      <div class="sol-body">
        The current plan addresses BP Ioff variation through LDD mask re-tapeout, PMOS NW Vt implant tuning, and SAB etch profile tuning ‚Äî all of which are incremental improvements to the existing LTPS backplane. A more fundamental solution is migrating to LTPO (Low Temperature Polycrystalline Oxide) hybrid backplane, which combines LTPS for driving TFTs with IGZO (indium gallium zinc oxide) for switching TFTs. IGZO TFTs achieve Ioff in the sub-pA range (vs. nA for LTPS), which would effectively eliminate the BP Ioff variation mechanism entirely. This technology is used in Apple Watch Series 7+ and iPhone 15 Pro displays. While this is a longer-term solution requiring significant process investment, it should be evaluated as a roadmap item for EVT3 and beyond.
      </div>
      <div class="sol-tags">
        <span class="sol-tag sol-tag-high">High Impact</span>
        <span class="sol-tag sol-tag-high">High Effort (Long-term)</span>
        <span class="sol-tag sol-tag-novel">Not in Current Plan</span>
      </div>
    </div>

    <div class="solution-card" style="border-left:4px solid var(--green);">
      <div class="sol-header">
        <div class="sol-icon">üîå</div>
        <div>
          <div class="sol-title">Leakage Prevention Method (LPM) Pixel Circuit</div>
          <div class="sol-meta">Addresses: BD Type 4 (BP Ioff variation) ¬∑ Estimated gain: 30‚Äì50% reduction in Ioff-related BD without process changes</div>
        </div>
      </div>
      <div class="sol-body">
        Published in IEEE Transactions on Electron Devices (Lin et al., 2022), the Leakage Prevention Method (LPM) uses a dedicated LPM transistor in the pixel circuit to balance off-currents at the gate node of the driving TFT, eliminating OLED current drop due to Ioff variation. This is a pixel circuit design change ‚Äî not a process change ‚Äî meaning it can be implemented without modifying the LTPS process flow. The LPM approach has been validated in AMOLED smartwatch displays and achieves significant Ioff compensation. This is a near-term solution that could be implemented in the EVT2-POR or EVT3 build without requiring a new process qualification.
      </div>
      <div class="sol-tags">
        <span class="sol-tag sol-tag-high">High Impact</span>
        <span class="sol-tag sol-tag-med">Medium Effort</span>
        <span class="sol-tag sol-tag-novel">Not in Current Plan</span>
      </div>
    </div>

    <div class="solution-card" style="border-left:4px solid var(--green);">
      <div class="sol-header">
        <div class="sol-icon">üíß</div>
        <div>
          <div class="sol-title">H‚ÇÇO High-Pressure Post-Annealing (HPPA) for LTPS TFT</div>
          <div class="sol-meta">Addresses: BD Type 4 (BP Ioff uniformity) ¬∑ Estimated gain: Significant improvement in Ioff mean and sigma without mask changes</div>
        </div>
      </div>
      <div class="sol-body">
        Research by Yoo et al. (2023, ScienceDirect) demonstrates that H‚ÇÇO high-pressure post-annealing (HPPA) significantly improves both LTPS and a-IGZO TFT uniformity and reliability. The treatment passivates interface traps and reduces threshold voltage variation, directly improving Ioff uniformity across the panel. This is a process-level fix that does not require mask changes or circuit redesign, making it a relatively low-risk addition to the existing LTPS process flow. The current Goerpixel plan does not include HPPA as a corrective action for BP Ioff variation.
      </div>
      <div class="sol-tags">
        <span class="sol-tag sol-tag-med">Medium Impact</span>
        <span class="sol-tag sol-tag-low">Low Effort</span>
        <span class="sol-tag sol-tag-novel">Not in Current Plan</span>
      </div>
    </div>

    <div class="solution-card" style="border-left:4px solid var(--green);">
      <div class="sol-header">
        <div class="sol-icon">üß™</div>
        <div>
          <div class="sol-title">NBTI/HCI Stress Pre-Screening of Backplane</div>
          <div class="sol-meta">Addresses: BD Type 4/5 (BP weak TFTs) ¬∑ Estimated gain: Screens out weak TFTs before OLED deposition</div>
        </div>
      </div>
      <div class="sol-body">
        Negative Bias Temperature Instability (NBTI) and Hot Carrier Injection (HCI) are the two primary reliability degradation mechanisms in LTPS TFTs. Pre-aging the backplane at elevated temperature and voltage before OLED deposition screens out TFTs that would fail early in the field ‚Äî converting field failures into manufacturing rejects where they can be caught and analyzed. This is standard practice in high-reliability display manufacturing but is not mentioned in the current Goerpixel corrective action plan. The current plan mentions HCI and NBTI qualification checks for the LDD re-tapeout but does not include pre-screening as a yield improvement tool.
      </div>
      <div class="sol-tags">
        <span class="sol-tag sol-tag-med">Medium Impact</span>
        <span class="sol-tag sol-tag-low">Low Effort</span>
        <span class="sol-tag sol-tag-novel">Not in Current Plan</span>
      </div>
    </div>
  </div>

  <div class="inner-panel" id="panel-sol-aoi">
    <div class="solution-card" style="border-left:4px solid var(--purple);">
      <div class="sol-header">
        <div class="sol-icon">ü§ñ</div>
        <div>
          <div class="sol-title">AI/ML Re-classification to Reduce AOI False Positives (Overkill)</div>
          <div class="sol-meta">Addresses: TFE AOI NG (overkill) ¬∑ Estimated gain: 30‚Äì50% reduction in overkill rate based on published ML results</div>
        </div>
      </div>
      <div class="sol-body">
        Research published in TechRxiv (2025) demonstrates that machine learning classifiers applied to AOI tabular data reduce false positive rates by 30‚Äì50% without any hardware changes. The key insight is training the classifier on confirmed overkill cases from CT/AMT correlation data ‚Äî which Goerpixel already has from the EVT2 build. The current plan mentions AOI algorithm optimization for CT/AMT correlation, but this appears to be a threshold-tuning approach. A full ML re-classification system would be significantly more powerful, as it can learn complex non-linear decision boundaries that rule-based threshold systems cannot capture. The 2026 AI-powered OLED paper (Journal of Materials Chemistry C) further confirms that deep learning is now proven effective for OLED manufacturing defect detection and classification.
      </div>
      <div class="sol-tags">
        <span class="sol-tag sol-tag-high">High Impact</span>
        <span class="sol-tag sol-tag-med">Medium Effort</span>
        <span class="sol-tag sol-tag-novel">Partially in Plan (enhanced version)</span>
      </div>
    </div>

    <div class="solution-card" style="border-left:4px solid var(--purple);">
      <div class="sol-header">
        <div class="sol-icon">üí°</div>
        <div>
          <div class="sol-title">Multi-Modal AOI: EL + Reflectance (Dark-field + Bright-field)</div>
          <div class="sol-meta">Addresses: TFE AOI NG (classification accuracy) ¬∑ Estimated gain: Improved defect type classification, reduced overkill</div>
        </div>
      </div>
      <div class="sol-body">
        Standard TFE AOI uses only electroluminescence (EL) imaging. Combining EL AOI with reflectance AOI (dark-field and bright-field illumination) at the same inspection station provides multi-modal information that dramatically improves defect classification accuracy. For example, a particle that causes an EL anomaly can be simultaneously imaged in reflectance to determine its size, shape, and surface properties ‚Äî enabling automated classification of BD Type 1 vs. Type 2 vs. Type 3 without manual FA. This reduces both overkill (false positives) and underkill (false negatives) simultaneously. This approach is used in advanced semiconductor AOI systems but has not been widely adopted in OLED display manufacturing.
      </div>
      <div class="sol-tags">
        <span class="sol-tag sol-tag-high">High Impact</span>
        <span class="sol-tag sol-tag-high">High Effort</span>
        <span class="sol-tag sol-tag-novel">Not in Current Plan</span>
      </div>
    </div>

    <div class="solution-card" style="border-left:4px solid var(--purple);">
      <div class="sol-header">
        <div class="sol-icon">üìä</div>
        <div>
          <div class="sol-title">Dynamic Adaptive AOI Thresholds (Position + Lot-to-Lot)</div>
          <div class="sol-meta">Addresses: TFE AOI NG (systematic overkill) ¬∑ Estimated gain: 10‚Äì20% overkill reduction</div>
        </div>
      </div>
      <div class="sol-body">
        Fixed AOI thresholds applied uniformly across the panel and across lots cause systematic overkill in regions with known higher baseline variation (e.g., panel edges vs. center). Implementing adaptive thresholds that adjust based on within-panel position and lot-to-lot baseline variation would reduce systematic overkill without increasing underkill. This is a software-only change to the AOI system that can be implemented rapidly. The position-dependent threshold approach is particularly relevant for TFE AOI where edge effects from the encapsulation process create systematic EL non-uniformity that is not a true defect.
      </div>
      <div class="sol-tags">
        <span class="sol-tag sol-tag-med">Medium Impact</span>
        <span class="sol-tag sol-tag-low">Low Effort</span>
        <span class="sol-tag sol-tag-novel">Not in Current Plan</span>
      </div>
    </div>
  </div>

  <div class="inner-panel" id="panel-sol-bonding">
    <div class="solution-card" style="border-left:4px solid var(--red);">
      <div class="sol-header">
        <div class="sol-icon">üîó</div>
        <div>
          <div class="sol-title">Laser-Assisted ACF Bonding (LAB) for Uniform Heat Distribution</div>
          <div class="sol-meta">Addresses: V-Line (bonding resistance abnormal) ¬∑ Estimated gain: 40‚Äì60% reduction in ACF over-pressed particle defects</div>
        </div>
      </div>
      <div class="sol-body">
        Laser-assisted bonding (LAB) provides more uniform heat distribution than conventional thermocompression bonding, reducing the occurrence of over-pressed ACF particles that cause V-line defects. In thermocompression bonding, the heating element contacts the bonding tool, creating temperature gradients that result in non-uniform particle compression. LAB uses a laser to heat the bonding area directly and uniformly, achieving more consistent particle deformation across the entire bonding width. This technology is used in high-end display fabs (particularly for flexible OLED bonding) and has been shown to reduce bonding-related yield loss by 40‚Äì60%. The current plan optimizes ACF pressure and particle softness but does not consider the bonding method itself.
      </div>
      <div class="sol-tags">
        <span class="sol-tag sol-tag-high">High Impact</span>
        <span class="sol-tag sol-tag-med">Medium Effort</span>
        <span class="sol-tag sol-tag-novel">Not in Current Plan</span>
      </div>
    </div>

    <div class="solution-card" style="border-left:4px solid var(--red);">
      <div class="sol-header">
        <div class="sol-icon">üîå</div>
        <div>
          <div class="sol-title">NCA + Solder Bump Hybrid Bonding for Critical I/O Pads</div>
          <div class="sol-meta">Addresses: V-Line (bonding resistance) ¬∑ Estimated gain: Eliminates ACF particle over-compression at critical pads</div>
        </div>
      </div>
      <div class="sol-body">
        For critical I/O pads where bonding resistance is most sensitive, replacing ACF with a non-conductive adhesive (NCA) combined with solder bump interconnects eliminates ACF particle over-compression entirely. In this hybrid approach, electrical connection is made through solder bumps (which are not sensitive to compression variation) while the NCA provides mechanical adhesion and environmental protection. This approach is used in high-reliability display bonding and eliminates the fundamental mechanism causing 83.9% of V-line defects. While requiring a pad design change, it provides a permanent solution rather than an optimization of the existing ACF process.
      </div>
      <div class="sol-tags">
        <span class="sol-tag sol-tag-high">High Impact</span>
        <span class="sol-tag sol-tag-high">High Effort</span>
        <span class="sol-tag sol-tag-novel">Not in Current Plan</span>
      </div>
    </div>

    <div class="solution-card" style="border-left:4px solid var(--red);">
      <div class="sol-header">
        <div class="sol-icon">üì°</div>
        <div>
          <div class="sol-title">OC Layer Dielectric Optimization to Prevent CT Crosstalk</div>
          <div class="sol-meta">Addresses: V-Line (BP CT crosstalk) ¬∑ Estimated gain: May reduce 16.1% of V-line defects from crosstalk</div>
        </div>
      </div>
      <div class="sol-body">
        The OC (overcoat) protection layer added in Plan B+1 should be evaluated for its dielectric constant and thickness. An excessively thick or high-permittivity OC layer can increase parasitic capacitance between adjacent signal lines, potentially exacerbating the CT crosstalk that causes 16.1% of V-line defects. The current plan does not appear to include a dielectric characterization of the OC layer in relation to crosstalk. Optimizing OC layer thickness and material selection (lower dielectric constant) could reduce parasitic capacitance and mitigate crosstalk-related V-lines without requiring BP circuit changes.
      </div>
      <div class="sol-tags">
        <span class="sol-tag sol-tag-med">Medium Impact</span>
        <span class="sol-tag sol-tag-low">Low Effort</span>
        <span class="sol-tag sol-tag-novel">Not in Current Plan</span>
      </div>
    </div>
  </div>

  <div class="inner-panel" id="panel-sol-novel">
    <div class="solution-card" style="border-left:4px solid var(--teal);">
      <div class="sol-header">
        <div class="sol-icon">üñ®Ô∏è</div>
        <div>
          <div class="sol-title">Laser Pixel Repair (Hummink NAZCA Additive Microprinting)</div>
          <div class="sol-meta">Addresses: Post-fabrication yield recovery for BD/DD rejects ¬∑ Estimated gain: Convert 5‚Äì15% of rejects to passing panels</div>
        </div>
      </div>
      <div class="sol-body">
        Hummink's NAZCA system enables localized additive microprinting to repair individual defective pixels or interconnects post-fabrication. This is a yield recovery tool that can convert some BD/DD rejects into passing panels by depositing conductive or insulating material at the defect site to restore pixel function. For Type 2 BD defects (cathode-anode short via Ti particle), the repair involves depositing an insulating material over the particle to break the short. For open-circuit DDs (Type 4 no-abnormal FE), the repair involves depositing a conductive bridge. This technology is commercially available and has been demonstrated in OLED display repair applications. It is not a process fix but a yield recovery tool that can improve overall output without changing the manufacturing process.
      </div>
      <div class="sol-tags">
        <span class="sol-tag sol-tag-high">High Impact (Yield Recovery)</span>
        <span class="sol-tag sol-tag-med">Medium Effort</span>
        <span class="sol-tag sol-tag-novel">Not in Current Plan</span>
      </div>
    </div>

    <div class="solution-card" style="border-left:4px solid var(--teal);">
      <div class="sol-header">
        <div class="sol-icon">üß†</div>
        <div>
          <div class="sol-title">AI-Powered Defect Root Cause Classification from EL Images</div>
          <div class="sol-meta">Addresses: FA cycle time reduction ¬∑ Estimated gain: Reduce FA cycle time from days to hours; enable faster CA implementation</div>
        </div>
      </div>
      <div class="sol-body">
        Deep learning models trained on EL images can classify defect types (BD Type 1/2/3/4, DD Type 2/3/4) automatically, reducing FA cycle time from days to hours. The 2026 AI-powered OLED paper (Journal of Materials Chemistry C, Sarma & Chatterjee) confirms that ML and deep learning are proven effective for OLED manufacturing defect detection and classification. The current FA process requires manual microscopy, FIB/SEM, and EDS analysis for each defect ‚Äî a process that takes 2‚Äì5 days per defect type. An automated EL-image-based classifier could triage defects in minutes, directing only ambiguous cases to manual FA. This would accelerate the corrective action feedback loop significantly, enabling faster yield improvement iterations.
      </div>
      <div class="sol-tags">
        <span class="sol-tag sol-tag-high">High Impact (Speed)</span>
        <span class="sol-tag sol-tag-med">Medium Effort</span>
        <span class="sol-tag sol-tag-novel">Not in Current Plan</span>
      </div>
    </div>

    <div class="solution-card" style="border-left:4px solid var(--teal);">
      <div class="sol-header">
        <div class="sol-icon">‚ö°</div>
        <div>
          <div class="sol-title">ESD Monitoring at Key Transfer Points</div>
          <div class="sol-meta">Addresses: BD/DD defects misclassified as process defects ¬∑ Estimated gain: Identifies and eliminates ESD-induced yield loss</div>
        </div>
      </div>
      <div class="sol-body">
        Electrostatic discharge (ESD) events during panel handling can create BD and DD defects that are indistinguishable from process-induced defects in standard FA. ESD damage typically manifests as pixel shorts (BD) or opens (DD) at the anode-cathode interface, with no visible particle or contamination. The current FA plan does not include ESD as a potential root cause for the "no abnormal found" DD cases (18.2% of analyzed DDs). Adding ESD monitoring at key transfer points ‚Äî post-PDL, post-OLED deposition, and post-TFE ‚Äî using wrist strap monitors, ionizers, and ESD event loggers would identify if ESD is contributing to yield loss. This is a low-cost, high-value diagnostic step.
      </div>
      <div class="sol-tags">
        <span class="sol-tag sol-tag-med">Medium Impact</span>
        <span class="sol-tag sol-tag-low">Low Effort</span>
        <span class="sol-tag sol-tag-novel">Not in Current Plan</span>
      </div>
    </div>

    <div class="solution-card" style="border-left:4px solid var(--teal);">
      <div class="sol-header">
        <div class="sol-icon">üõ°Ô∏è</div>
        <div>
          <div class="sol-title">Spotless Hybrid TFE Stack with Self-Planarizing Organic Layer</div>
          <div class="sol-meta">Addresses: DD Type 4 (in-film particle in TFE/OC layers) ¬∑ Estimated gain: Reduces particle-induced dark spots in encapsulation layers</div>
        </div>
      </div>
      <div class="sol-body">
        Research on "spotless" hybrid TFE stacks (ScienceDirect) demonstrates that a hybrid inorganic/organic TFE architecture with an optimized self-planarizing organic interlayer significantly reduces particle-induced dark spots. The organic interlayer flows around particles during deposition, burying them and preventing them from creating pinholes in the subsequent inorganic barrier layer. The current TFE process likely uses a standard inorganic/organic stack, but the specific organic layer formulation and thickness may not be optimized for particle burial. Evaluating a thicker or lower-viscosity organic interlayer formulation could reduce DD Type 4 defects from in-film particles in the TFE stack.
      </div>
      <div class="sol-tags">
        <span class="sol-tag sol-tag-med">Medium Impact</span>
        <span class="sol-tag sol-tag-med">Medium Effort</span>
        <span class="sol-tag sol-tag-novel">Not in Current Plan</span>
      </div>
    </div>
  </div>
</div>

<div class="page" id="page-changelog" style="display:none;">
  <div class="section-title" style="margin-bottom:16px;">üìã Change Log ‚Äî Audit Trail</div>
  <div class="card" style="margin-bottom:16px;">
    <div class="card-title"><span class="icon">‚ÑπÔ∏è</span> About the Change Log</div>
    <div style="font-size:13px;color:#555;line-height:1.6;">
      Every change made to yield data and FACA status is automatically recorded here with the
      editor's email address and timestamp. This log is stored in the <strong>ChangeLog</strong>
      tab of your Google Sheet and cannot be edited manually.
      <br><br>
      <strong>Note:</strong> Changes made directly in the Google Sheet (by any Meta user with access)
      are also captured via the Apps Script <code>onSheetEdit</code> trigger.
    </div>
  </div>
  <div class="card">
    <div class="card-title" style="display:flex;justify-content:space-between;align-items:center;">
      <span><span class="icon">üïê</span> Recent Changes</span>
      <button onclick="loadChangeLog()"
              style="padding:6px 16px;background:#1F3864;color:#fff;border:none;border-radius:6px;font-size:12px;cursor:pointer;">
        üîÑ Refresh
      </button>
    </div>
    <div id="changelog-container">
      <div style="color:#888;padding:16px;font-style:italic;">Click Refresh to load the change log.</div>
    </div>
  </div>
</div>


<div class="footer">
  OLED Yield & FACA Tracker ¬∑ Goerpixel / Sony ¬∑ Pre-EVT2 & EVT2 Build ¬∑ 2026-02-26 ¬∑ All data saved locally in your browser
</div>

<!-- MODAL for notes editing -->
<div class="modal-overlay" id="notesModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal()">√ó</button>
    <div class="modal-title">Edit Notes</div>
    <div style="margin-bottom:8px;font-size:13px;color:var(--text-muted);" id="modalActionLabel"></div>
    <textarea id="modalNotesInput" style="width:100%;height:120px;padding:8px;border:1.5px solid var(--border);border-radius:6px;font-size:13px;resize:vertical;" placeholder="Add notes, observations, or updates..."></textarea>
    <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end;">
      <button class="btn btn-outline btn-sm" onclick="closeModal()">Cancel</button>
      <button class="btn btn-success btn-sm" onclick="saveNotes()">Save Notes</button>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA MODEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Chart.register(ChartDataLabels);

const DEFAULT_DATA = {
  baseline: 3.58,
  actual: 7.00,
  target: 10.00,
  defectRatios: {
    BD: 67.41,
    DD: 10.57,
    CP: 5.56,
    TFE: 4.50,
    VL: 3.22,
    Other: 8.74
  },
  caActions: [
    { id: 'ca1',  cat: 'BD',  label: 'BD FE Fix ‚Äî ETL thickening (PM3 Ver. C)',          gain: 0.72, status: 'Not Started', notes: '' },
    { id: 'ca2',  cat: 'BD',  label: 'BD FE Fix ‚Äî PDL mask change (cathode ring)',         gain: 0.30, status: 'Not Started', notes: '' },
    { id: 'ca3',  cat: 'BD',  label: 'BD FE Fix ‚Äî Ti/ITO particle control',               gain: 0.20, status: 'Not Started', notes: '' },
    { id: 'ca4',  cat: 'BD',  label: 'BD BP Fix ‚Äî ELVSS optimization',                    gain: 0.18, status: 'Not Started', notes: '' },
    { id: 'ca5',  cat: 'BD',  label: 'BD BP Fix ‚Äî BPIC Ioff improvement (LDD re-tapeout)',gain: 0.24, status: 'Not Started', notes: '' },
    { id: 'ca6',  cat: 'DD',  label: 'DD FE Fix ‚Äî Ti particle ctrl (PDL mask EVT2-POR)',  gain: 0.12, status: 'Not Started', notes: '' },
    { id: 'ca7',  cat: 'DD',  label: 'DD FE Fix ‚Äî OLED EL mask change',                   gain: 0.06, status: 'Not Started', notes: '' },
    { id: 'ca8',  cat: 'DD',  label: 'DD ‚Äî PDL removal process optimization',             gain: 0.05, status: 'Not Started', notes: '' },
    { id: 'ca9',  cat: 'DD',  label: 'DD ‚Äî In-film particle source investigation',        gain: 0.04, status: 'Not Started', notes: '' },
    { id: 'ca10', cat: 'CP',  label: 'CP NG ‚Äî EFA/PFA leakage mode (by 2026-03-05)',      gain: 0.08, status: 'In Progress', notes: 'EFA in progress. Target completion 2026-03-05.' },
    { id: 'ca11', cat: 'CP',  label: 'CP NG ‚Äî EFA/PFA short mode (by 2026-03-05)',        gain: 0.04, status: 'In Progress', notes: 'EFA in progress. Target completion 2026-03-05.' },
    { id: 'ca12', cat: 'TFE', label: 'TFE AOI ‚Äî EL mask update (EVT2 B+3 POR2)',          gain: 0.04, status: 'Not Started', notes: '' },
    { id: 'ca13', cat: 'TFE', label: 'TFE AOI ‚Äî Particle reduction (EV/EN high rate)',    gain: 0.02, status: 'Not Started', notes: '' },
    { id: 'ca14', cat: 'TFE', label: 'TFE AOI ‚Äî Algorithm optimization (CT/AMT corr.)',   gain: 0.02, status: 'Not Started', notes: '' },
    { id: 'ca15', cat: 'VL',  label: 'V-Line ‚Äî Bonding optimization (ACF pressure/indent)',gain: 0.12, status: 'Not Started', notes: '' },
    { id: 'ca16', cat: 'VL',  label: 'V-Line ‚Äî BP CT crosstalk (PFA investigation)',      gain: 0.03, status: 'Not Started', notes: '' },
  ]
};

const DEFECT_DETAILS = [
  { cat:'BD', label:'Bright Dot', ratio:67.41, qty:1012, rootCause:'Ti particle on PDL footer; BP Ioff variation', keyCA:'ETL thickening; PDL mask change; LDD re-tapeout', gain:'+1.64 pp', rowClass:'bd-row', color:'#E67E22' },
  { cat:'DD', label:'Dark Dot',   ratio:10.57, qty:207,  rootCause:'Conductive particle short; in-film particle',  keyCA:'Ti particle ctrl; PDL mask; EL mask change',     gain:'+0.27 pp', rowClass:'dd-row', color:'#2980B9' },
  { cat:'CP', label:'CP NG',      ratio:5.56,  qty:327,  rootCause:'Leakage (84.5%); Short (11.3%); GOA (4.2%)',  keyCA:'EFA/PFA by 2026-03-05',                          gain:'+0.12 pp', rowClass:'cp-row', color:'#27AE60' },
  { cat:'TFE',label:'TFE AOI NG', ratio:4.50,  qty:263,  rootCause:'FE particle OOS; some overkill',              keyCA:'EL mask update; AOI algorithm optimization',      gain:'+0.08 pp', rowClass:'tfe-row',color:'#8E44AD' },
  { cat:'VL', label:'V-Line',     ratio:3.22,  qty:56,   rootCause:'ACF over-pressed (83.9%); BP crosstalk (16.1%)',keyCA:'Bonding optimization; BP PFA',                  gain:'+0.15 pp', rowClass:'vl-row', color:'#C0392B' },
];

const CAT_COLORS = { BD:'#E67E22', DD:'#2980B9', CP:'#27AE60', TFE:'#8E44AD', VL:'#C0392B', Other:'#95A5A6' };
const STATUS_ORDER = ['Not Started','In Progress','Completed','Verified'];

let appData = JSON.parse(JSON.stringify(DEFAULT_DATA));
let charts = {};
let modalEditId = null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PERSISTENCE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadData() {
  try {
    const saved = localStorage.getItem('oledTrackerData');
    if (saved) appData = JSON.parse(saved);
  } catch(e) {}
}

function saveData() {
  try {
    localStorage.setItem('oledTrackerData', JSON.stringify(appData));
    const ind = document.getElementById('saveIndicator');
    const st = document.getElementById('saveStatus');
    ind.style.background = '#4CAF50';
    st.textContent = 'Saved at ' + new Date().toLocaleTimeString();
    setTimeout(() => { ind.style.background = '#4CAF50'; }, 2000);
  } catch(e) {}
}

function resetToDefaults() {
  if (!confirm('Reset all data to defaults? This cannot be undone.')) return;
  appData = JSON.parse(JSON.stringify(DEFAULT_DATA));
  saveData();
  updateAll();
  renderFACATable();
  renderFACAKPIs();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  const pageEl = document.getElementById('page-' + id);
  if (pageEl) { pageEl.classList.add('active'); pageEl.style.display = 'block'; }
  // Hide all other pages
  document.querySelectorAll('.page').forEach(p => { if (p !== pageEl) p.style.display = ''; });
  // Find matching nav tab by onclick attribute
  document.querySelectorAll('.nav-tab').forEach(t => {
    if (t.getAttribute('onclick') && t.getAttribute('onclick').includes("'" + id + "'")) {
      t.classList.add('active');
    }
  });
  updateAll();
}

function showInnerTab(id) {
  const tabs = event.target.parentElement.querySelectorAll('.inner-tab');
  const panels = event.target.closest('.page, .inner-panel').querySelectorAll(':scope > .inner-panel');
  tabs.forEach(t => t.classList.remove('active'));
  panels.forEach(p => p.classList.remove('active'));
  event.target.classList.add('active');
  const panel = document.getElementById('panel-' + id);
  if (panel) panel.classList.add('active');
  // Re-render charts in newly visible panel
  setTimeout(() => renderDefectCharts(), 100);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CALCULATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getTotalExpectedGain() {
  return appData.caActions.reduce((s, a) => s + a.gain, 0);
}

function getCompletedGain() {
  return appData.caActions
    .filter(a => a.status === 'Completed' || a.status === 'Verified')
    .reduce((s, a) => s + a.gain, 0);
}

function getProjectedYield() {
  return Math.min(100, appData.actual + getTotalExpectedGain());
}

function getFACAProgress() {
  const done = appData.caActions.filter(a => a.status === 'Completed' || a.status === 'Verified').length;
  return { done, total: appData.caActions.length, pct: Math.round(done / appData.caActions.length * 100) };
}

function getDelta() {
  return (appData.actual - appData.baseline).toFixed(2);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UPDATE ALL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateAll() {
  syncInputsToData();
  updateKPIs();
  renderSummaryTable();
  renderYieldBridge();
  renderBridgeTable();
  renderYieldGapAnalysis();
  renderDefectRatioEditor();
  renderCAGainEditor();
  renderLivePreview();
  renderFACAProgressBars();
  renderFACAKPIs();
  renderCharts();
  updateDefectDisplays();
  saveData();
}

function syncInputsToData() {
  const b = parseFloat(document.getElementById('input-baseline')?.value);
  const a = parseFloat(document.getElementById('input-actual')?.value);
  const t = parseFloat(document.getElementById('input-target')?.value);
  if (!isNaN(b)) appData.baseline = b;
  if (!isNaN(a)) appData.actual = a;
  if (!isNaN(t)) appData.target = t;
}

function updateKPIs() {
  const prog = getFACAProgress();
  const projected = getProjectedYield();
  const delta = getDelta();

  setText('kpi-overall', appData.actual.toFixed(2) + '%');
  setText('kpi-delta', (delta >= 0 ? '‚ñ≤ +' : '‚ñº ') + delta + ' pp vs Pre-EVT2');
  document.getElementById('kpi-delta').className = 'kpi-delta ' + (delta >= 0 ? 'up' : 'down');
  setText('kpi-bd', appData.defectRatios.BD.toFixed(2) + '%');
  setText('kpi-dd', appData.defectRatios.DD.toFixed(2) + '%');
  setText('kpi-faca', prog.pct + '%');
  setText('kpi-faca-sub', prog.done + ' / ' + prog.total + ' actions completed');
  setText('kpi-projected', projected.toFixed(2) + '%');
}

function updateDefectDisplays() {
  const ids = { BD:'bd', DD:'dd', CP:'cp', TFE:'tfe', VL:'vl' };
  for (const [cat, prefix] of Object.entries(ids)) {
    const el = document.getElementById(prefix + '-ratio-display');
    if (el) el.textContent = (appData.defectRatios[cat] || 0).toFixed(2) + '%';
  }
}

function setText(id, val) {
  const el = document.getElementById(id);
  if (el) el.textContent = val;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUMMARY TABLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderSummaryTable() {
  const tbody = document.getElementById('summaryTableBody');
  if (!tbody) return;
  tbody.innerHTML = DEFECT_DETAILS.map(d => {
    const ratio = appData.defectRatios[d.cat] || d.ratio;
    const prog = getFACACategoryProgress(d.cat);
    return `<tr class="${d.rowClass}">
      <td><strong style="color:${d.color}">${d.label}</strong></td>
      <td><strong>${ratio.toFixed(2)}%</strong></td>
      <td>${d.qty.toLocaleString()}</td>
      <td style="font-size:11.5px;">${d.rootCause}</td>
      <td style="font-size:11.5px;">${d.keyCA}</td>
      <td><strong style="color:var(--green)">${d.gain}</strong></td>
      <td>${statusBadge(prog.status)}</td>
    </tr>`;
  }).join('');
}

function getFACACategoryProgress(cat) {
  const actions = appData.caActions.filter(a => a.cat === cat);
  const done = actions.filter(a => a.status === 'Completed' || a.status === 'Verified').length;
  if (done === actions.length) return { status: 'Verified' };
  if (done > 0) return { status: 'In Progress' };
  const inProg = actions.filter(a => a.status === 'In Progress').length;
  if (inProg > 0) return { status: 'In Progress' };
  return { status: 'Not Started' };
}

function statusBadge(status) {
  const cls = { 'Not Started':'badge-not-started','In Progress':'badge-in-progress','Completed':'badge-completed','Verified':'badge-verified' };
  return `<span class="badge ${cls[status] || 'badge-not-started'}">${status}</span>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// YIELD BRIDGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderYieldBridge() {
  const showOnlyCompleted = document.getElementById('showOnlyCompleted')?.checked;
  const actions = showOnlyCompleted
    ? appData.caActions.filter(a => a.status === 'Completed' || a.status === 'Verified')
    : appData.caActions;

  const labels = ['Baseline\n' + appData.baseline.toFixed(2) + '%'];
  const barData = [{ v: appData.baseline, bottom: 0, color: '#1F3864', status: 'Verified' }];
  let cumulative = appData.baseline;

  for (const a of actions) {
    labels.push(a.label.split('‚Äî')[0].trim().replace(' Fix','').replace(' NG',''));
    const bottom = cumulative;
    cumulative = Math.round((cumulative + a.gain) * 1000) / 1000;
    const isDone = a.status === 'Completed' || a.status === 'Verified';
    barData.push({ v: a.gain, bottom, color: CAT_COLORS[a.cat], status: a.status, isDone });
  }

  labels.push('EVT2\nActual\n' + appData.actual.toFixed(2) + '%');
  barData.push({ v: appData.actual, bottom: 0, color: '#1A5276', status: 'Verified' });

  const ctx = document.getElementById('chartYieldBridge');
  if (!ctx) return;

  if (charts.yieldBridge) charts.yieldBridge.destroy();

  const datasets = [{
    label: 'Yield',
    data: barData.map(b => [b.bottom, b.bottom + b.v]),
    backgroundColor: barData.map(b => {
      if (b.status === 'Not Started') return b.color + '55';
      if (b.status === 'In Progress') return b.color + 'AA';
      return b.color;
    }),
    borderColor: barData.map(b => b.color),
    borderWidth: 1.5,
    borderRadius: 4,
  }];

  charts.yieldBridge = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        datalabels: {
          anchor: 'end',
          align: 'top',
          formatter: (val, ctx2) => {
            const b = barData[ctx2.dataIndex];
            if (ctx2.dataIndex === 0 || ctx2.dataIndex === barData.length - 1) return b.v.toFixed(2) + '%';
            return '+' + b.v.toFixed(2) + 'pp';
          },
          color: (ctx2) => barData[ctx2.dataIndex].color,
          font: { size: 10, weight: 'bold' }
        },
        tooltip: {
          callbacks: {
            label: (ctx2) => {
              const b = barData[ctx2.dataIndex];
              if (ctx2.dataIndex === 0 || ctx2.dataIndex === barData.length - 1)
                return 'Yield: ' + b.v.toFixed(2) + '%';
              return 'Gain: +' + b.v.toFixed(2) + 'pp | Status: ' + b.status;
            }
          }
        }
      },
      scales: {
        x: { grid: { display: false }, ticks: { font: { size: 10 } } },
        y: {
          min: 0,
          max: Math.max(12, appData.target + 2),
          title: { display: true, text: 'Yield (%)', font: { size: 12 } },
          grid: { color: '#E9ECEF' }
        }
      }
    }
  });
}

function renderBridgeTable() {
  const tbody = document.getElementById('bridgeTableBody');
  if (!tbody) return;
  let cumulative = appData.baseline;
  let rows = `<tr>
    <td>0</td><td><strong>Pre-EVT2 Baseline</strong></td><td>‚Äî</td>
    <td>‚Äî</td><td><strong>${appData.baseline.toFixed(2)}%</strong></td>
    <td>${statusBadge('Verified')}</td>
  </tr>`;
  appData.caActions.forEach((a, i) => {
    cumulative = Math.round((cumulative + a.gain) * 1000) / 1000;
    rows += `<tr>
      <td>${i+1}</td>
      <td style="font-size:12px;">${a.label}</td>
      <td><span style="color:${CAT_COLORS[a.cat]};font-weight:700;">${a.cat}</span></td>
      <td><strong style="color:var(--green)">+${a.gain.toFixed(2)} pp</strong></td>
      <td>${cumulative.toFixed(2)}%</td>
      <td>${statusBadge(a.status)}</td>
    </tr>`;
  });
  rows += `<tr style="background:#EBF5FB;">
    <td>‚Äî</td><td><strong>EVT2 Actual (Plan B)</strong></td><td>‚Äî</td>
    <td>‚Äî</td><td><strong>${appData.actual.toFixed(2)}%</strong></td>
    <td>${statusBadge('Verified')}</td>
  </tr>`;
  tbody.innerHTML = rows;
}

function renderYieldGapAnalysis() {
  const el = document.getElementById('yieldGapAnalysis');
  if (!el) return;
  const totalGain = getTotalExpectedGain();
  const completedGain = getCompletedGain();
  const gap = appData.target - appData.actual;
  const projectedFinal = getProjectedYield();
  const remainingGap = Math.max(0, appData.target - projectedFinal);

  el.innerHTML = `
    <div style="margin-bottom:12px;">
      <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
        <span style="font-size:13px;font-weight:600;">Current vs. Target Gap</span>
        <span style="font-size:13px;color:var(--red);font-weight:700;">${gap.toFixed(2)} pp</span>
      </div>
      <div class="progress-bar"><div class="progress-fill" style="width:${Math.min(100,(appData.actual/appData.target*100)).toFixed(1)}%;background:var(--navy);"></div></div>
      <div style="font-size:11px;color:var(--text-muted);margin-top:4px;">Actual: ${appData.actual.toFixed(2)}% / Target: ${appData.target.toFixed(2)}%</div>
    </div>
    <div style="margin-bottom:12px;">
      <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
        <span style="font-size:13px;font-weight:600;">CA Completed Gain</span>
        <span style="font-size:13px;color:var(--green);font-weight:700;">+${completedGain.toFixed(2)} pp</span>
      </div>
      <div class="progress-bar"><div class="progress-fill" style="width:${Math.min(100,(completedGain/totalGain*100)).toFixed(1)}%;background:var(--green);"></div></div>
      <div style="font-size:11px;color:var(--text-muted);margin-top:4px;">${completedGain.toFixed(2)} / ${totalGain.toFixed(2)} pp total expected gain realized</div>
    </div>
    <div style="margin-bottom:12px;">
      <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
        <span style="font-size:13px;font-weight:600;">Projected Yield (all CA done)</span>
        <span style="font-size:13px;color:var(--blue);font-weight:700;">${projectedFinal.toFixed(2)}%</span>
      </div>
      <div class="progress-bar"><div class="progress-fill" style="width:${Math.min(100,(projectedFinal/appData.target*100)).toFixed(1)}%;background:var(--blue);"></div></div>
    </div>
    ${remainingGap > 0 ? `<div class="alert alert-warning" style="margin-top:8px;font-size:12px;">
      <strong>Gap remaining after all CA:</strong> ${remainingGap.toFixed(2)} pp. Additional corrective actions or process improvements are needed to reach the ${appData.target.toFixed(2)}% target.
    </div>` : `<div class="alert alert-success" style="margin-top:8px;font-size:12px;">
      <strong>Target achievable!</strong> Completing all planned CAs is projected to reach ${projectedFinal.toFixed(2)}%, exceeding the ${appData.target.toFixed(2)}% target.
    </div>`}
  `;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// YIELD EDITOR COMPONENTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDefectRatioEditor() {
  const el = document.getElementById('defectRatioEditor');
  if (!el) return;
  const cats = ['BD','DD','CP','TFE','VL','Other'];
  el.innerHTML = cats.map(cat => {
    const val = appData.defectRatios[cat] || 0;
    return `<div class="yield-editor-row">
      <div class="yield-editor-label" style="color:${CAT_COLORS[cat]}">${cat === 'BD' ? 'Bright Dot' : cat === 'DD' ? 'Dark Dot' : cat === 'CP' ? 'CP NG' : cat === 'TFE' ? 'TFE AOI NG' : cat === 'VL' ? 'V-Line' : 'Other'}</div>
      <div class="yield-editor-bar">
        <div class="progress-bar"><div class="progress-fill" style="width:${Math.min(100,val)}%;background:${CAT_COLORS[cat]};"></div></div>
      </div>
      <div class="yield-editor-input-wrap">
        <input type="number" class="yield-input" value="${val.toFixed(2)}" min="0" max="100" step="0.01"
          onchange="appData.defectRatios['${cat}']=parseFloat(this.value)||0;updateAll();">
        <span class="yield-editor-pct">%</span>
      </div>
    </div>`;
  }).join('');
}

function renderCAGainEditor() {
  const tbody = document.getElementById('caGainEditor');
  if (!tbody) return;
  tbody.innerHTML = appData.caActions.map(a => {
    const realized = (a.status === 'Completed' || a.status === 'Verified') ? a.gain : 0;
    return `<tr>
      <td style="font-size:12px;">${a.label}</td>
      <td><span style="color:${CAT_COLORS[a.cat]};font-weight:700;">${a.cat}</span></td>
      <td>
        <input type="number" class="yield-input" value="${a.gain.toFixed(2)}" min="0" max="10" step="0.01"
          onchange="updateCAGain('${a.id}', parseFloat(this.value)||0)">
        <span style="font-size:11px;color:var(--text-muted);margin-left:4px;">pp</span>
      </td>
      <td>
        <select class="status-select" onchange="updateCAStatus('${a.id}', this.value)">
          ${STATUS_ORDER.map(s => `<option value="${s}" ${a.status===s?'selected':''}>${s}</option>`).join('')}
        </select>
      </td>
      <td><strong style="color:${realized>0?'var(--green)':'var(--text-muted)'}">+${realized.toFixed(2)} pp</strong></td>
    </tr>`;
  }).join('');
}

function renderLivePreview() {
  const el = document.getElementById('livePreview');
  if (!el) return;
  const totalGain = getTotalExpectedGain();
  const completedGain = getCompletedGain();
  const projected = getProjectedYield();
  el.innerHTML = `
    <div class="kpi-card navy"><div class="kpi-label">Baseline</div><div class="kpi-value">${appData.baseline.toFixed(2)}%</div></div>
    <div class="kpi-card green"><div class="kpi-label">Actual (EVT2)</div><div class="kpi-value">${appData.actual.toFixed(2)}%</div><div class="kpi-delta up">+${getDelta()} pp</div></div>
    <div class="kpi-card amber"><div class="kpi-label">Total Expected CA Gain</div><div class="kpi-value">+${totalGain.toFixed(2)} pp</div></div>
    <div class="kpi-card blue"><div class="kpi-label">Projected Final Yield</div><div class="kpi-value">${projected.toFixed(2)}%</div><div class="kpi-sub">Target: ${appData.target.toFixed(2)}%</div></div>
  `;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FACA TRACKER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderFACATable() {
  const tbody = document.getElementById('facaTableBody');
  if (!tbody) return;
  const catFilter = document.getElementById('filterCategory')?.value || 'all';
  const statusFilter = document.getElementById('filterStatus')?.value || 'all';
  const filtered = appData.caActions.filter(a =>
    (catFilter === 'all' || a.cat === catFilter) &&
    (statusFilter === 'all' || a.status === statusFilter)
  );
  const rowClasses = { BD:'bd-row', DD:'dd-row', CP:'cp-row', TFE:'tfe-row', VL:'vl-row' };
  tbody.innerHTML = filtered.map((a, i) => {
    const detail = DEFECT_DETAILS.find(d => d.cat === a.cat) || {};
    return `<tr class="${rowClasses[a.cat]||''}">
      <td>${appData.caActions.indexOf(a)+1}</td>
      <td><span style="color:${CAT_COLORS[a.cat]};font-weight:700;">${a.cat}</span></td>
      <td style="font-size:12px;">${detail.rootCause ? detail.rootCause.split(';')[0] : '‚Äî'}</td>
      <td style="font-size:12px;">${a.label.split('‚Äî').slice(1).join('‚Äî').trim() || a.label}</td>
      <td style="font-size:12px;">${getCheckpoint(a.id)}</td>
      <td><strong style="color:var(--green)">+${a.gain.toFixed(2)} pp</strong></td>
      <td>
        <select class="status-select" onchange="updateCAStatus('${a.id}', this.value)">
          ${STATUS_ORDER.map(s => `<option value="${s}" ${a.status===s?'selected':''}>${s}</option>`).join('')}
        </select>
      </td>
      <td>
        <div style="font-size:11.5px;color:var(--text-muted);margin-bottom:4px;">${a.notes || '<em>No notes</em>'}</div>
        <button class="btn btn-outline btn-sm" onclick="openModal('${a.id}')">‚úèÔ∏è Edit</button>
      </td>
    </tr>`;
  }).join('');
}

function getCheckpoint(id) {
  const checkpoints = {
    ca1:'EVT2-POR build; AMT BD count pre/post ETL',
    ca2:'EVT2-POR Split build; Ti particle count post-PDL',
    ca3:'EVT2-POR Split; ITO/Ti particle monitoring',
    ca4:'Backup Batch / EVT2-POR; BPIC Ioff check',
    ca5:'EVT2-POR; BPIC Ioff mean & sigma; HCI/NBTI qual.',
    ca6:'EVT2-POR Split; particle count post-PDL; FIB/SEM',
    ca7:'EVT2-POR build; EL mask verification',
    ca8:'TBD ‚Äì PDL process review milestone',
    ca9:'TBD ‚Äì particle source identification',
    ca10:'EFA/PFA completion by 2026-03-05',
    ca11:'EFA/PFA completion by 2026-03-05',
    ca12:'EVT2 (B+3) POR2 build',
    ca13:'Ongoing particle count monitoring',
    ca14:'AOI overkill rate vs. CT/AMT correlation',
    ca15:'Next bonding batch yield check; ACF indentation',
    ca16:'BP team PFA review milestone (TBD)',
  };
  return checkpoints[id] || 'TBD';
}

function renderFACAProgressBars() {
  const el = document.getElementById('facaProgressBars');
  if (!el) return;
  const cats = ['BD','DD','CP','TFE','VL'];
  el.innerHTML = cats.map(cat => {
    const actions = appData.caActions.filter(a => a.cat === cat);
    const done = actions.filter(a => a.status === 'Completed' || a.status === 'Verified').length;
    const inProg = actions.filter(a => a.status === 'In Progress').length;
    const pct = Math.round(done / actions.length * 100);
    const label = { BD:'Bright Dot', DD:'Dark Dot', CP:'CP NG', TFE:'TFE AOI NG', VL:'V-Line' }[cat];
    return `<div style="margin-bottom:14px;">
      <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
        <span style="font-size:13px;font-weight:600;color:${CAT_COLORS[cat]}">${label}</span>
        <span style="font-size:12px;color:var(--text-muted)">${done}/${actions.length} done${inProg>0?' ¬∑ '+inProg+' in progress':''}</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" style="width:${pct}%;background:${CAT_COLORS[cat]};"></div>
      </div>
    </div>`;
  }).join('');
}

function renderFACAKPIs() {
  const el = document.getElementById('facaKpiCards');
  if (!el) return;
  const prog = getFACAProgress();
  const completedGain = getCompletedGain();
  const totalGain = getTotalExpectedGain();
  const inProg = appData.caActions.filter(a => a.status === 'In Progress').length;
  const verified = appData.caActions.filter(a => a.status === 'Verified').length;
  el.innerHTML = `
    <div class="kpi-card green">
      <div class="kpi-label">Actions Completed/Verified</div>
      <div class="kpi-value">${prog.done} / ${prog.total}</div>
      <div class="kpi-sub">${prog.pct}% complete</div>
    </div>
    <div class="kpi-card amber">
      <div class="kpi-label">In Progress</div>
      <div class="kpi-value">${inProg}</div>
      <div class="kpi-sub">actions currently active</div>
    </div>
    <div class="kpi-card blue">
      <div class="kpi-label">Yield Gain Realized</div>
      <div class="kpi-value">+${completedGain.toFixed(2)} pp</div>
      <div class="kpi-sub">of +${totalGain.toFixed(2)} pp total</div>
    </div>
    <div class="kpi-card navy">
      <div class="kpi-label">Verified Actions</div>
      <div class="kpi-value">${verified}</div>
      <div class="kpi-sub">confirmed in production</div>
    </div>
  `;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openModal(id) {
  modalEditId = id;
  const a = appData.caActions.find(x => x.id === id);
  if (!a) return;
  document.getElementById('modalActionLabel').textContent = a.label;
  document.getElementById('modalNotesInput').value = a.notes || '';
  document.getElementById('notesModal').classList.add('open');
}

function closeModal() {
  document.getElementById('notesModal').classList.remove('open');
  modalEditId = null;
}

function saveNotes() {
  if (!modalEditId) return;
  const a = appData.caActions.find(x => x.id === modalEditId);
  if (a) a.notes = document.getElementById('modalNotesInput').value;
  closeModal();
  renderFACATable();
  saveData();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CA UPDATES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateCAGain(id, val) {
  const a = appData.caActions.find(x => x.id === id);
  if (a) a.gain = val;
  updateAll();
}

function updateCAStatus(id, val) {
  const a = appData.caActions.find(x => x.id === id);
  if (a) a.status = val;
  updateAll();
  renderFACATable();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHARTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderCharts() {
  renderPieChart();
  renderYieldComparisonChart();
  renderYieldImpactChart();
  renderYieldBridge();
  renderDefectCharts();
}

function renderPieChart() {
  const ctx = document.getElementById('chartDefectPie');
  if (!ctx) return;
  if (charts.pie) charts.pie.destroy();
  const cats = ['BD','DD','CP','TFE','VL','Other'];
  const labels = ['Bright Dot','Dark Dot','CP NG','TFE AOI NG','V-Line','Other'];
  charts.pie = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels,
      datasets: [{
        data: cats.map(c => appData.defectRatios[c] || 0),
        backgroundColor: cats.map(c => CAT_COLORS[c]),
        borderWidth: 2,
        borderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'right', labels: { font: { size: 11 }, padding: 12 } },
        datalabels: {
          formatter: (val) => val > 2 ? val.toFixed(1) + '%' : '',
          color: '#fff',
          font: { size: 11, weight: 'bold' }
        }
      }
    }
  });
}

function renderYieldComparisonChart() {
  const ctx = document.getElementById('chartYieldComparison');
  if (!ctx) return;
  if (charts.comparison) charts.comparison.destroy();
  charts.comparison = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Pre-EVT2\nBaseline', 'EVT2\nActual', 'EVT2\nTarget', 'Projected\n(all CA done)'],
      datasets: [{
        label: 'Yield (%)',
        data: [appData.baseline, appData.actual, appData.target, getProjectedYield()],
        backgroundColor: ['#1F3864', '#27AE60', '#E67E22', '#2980B9'],
        borderRadius: 6,
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        datalabels: {
          anchor: 'end', align: 'top',
          formatter: v => v.toFixed(2) + '%',
          font: { size: 11, weight: 'bold' },
          color: '#333'
        }
      },
      scales: {
        y: { min: 0, max: Math.max(15, appData.target + 3), grid: { color: '#E9ECEF' } },
        x: { grid: { display: false } }
      }
    }
  });
}

function renderYieldImpactChart() {
  const ctx = document.getElementById('chartYieldImpact');
  if (!ctx) return;
  if (charts.impact) charts.impact.destroy();
  const sorted = [...appData.caActions].sort((a,b) => b.gain - a.gain).slice(0,8);
  charts.impact = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: sorted.map(a => a.label.split('‚Äî')[0].trim()),
      datasets: [{
        label: 'Expected Yield Gain (pp)',
        data: sorted.map(a => a.gain),
        backgroundColor: sorted.map(a => {
          const isDone = a.status === 'Completed' || a.status === 'Verified';
          return isDone ? CAT_COLORS[a.cat] : CAT_COLORS[a.cat] + '77';
        }),
        borderRadius: 4,
        borderWidth: 0
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        datalabels: {
          anchor: 'end', align: 'right',
          formatter: v => '+' + v.toFixed(2) + 'pp',
          font: { size: 10, weight: 'bold' },
          color: '#333'
        }
      },
      scales: {
        x: { min: 0, max: 1.0, grid: { color: '#E9ECEF' }, title: { display: true, text: 'Yield Gain (pp)' } },
        y: { grid: { display: false }, ticks: { font: { size: 10 } } }
      }
    }
  });
}

function renderDefectCharts() {
  // BD Types chart
  const bdCtx = document.getElementById('chartBDTypes');
  if (bdCtx) {
    if (charts.bdTypes) charts.bdTypes.destroy();
    charts.bdTypes = new Chart(bdCtx, {
      type: 'doughnut',
      data: {
        labels: ['Type 1 (FE-CGL leak)', 'Type 2 (FE-Ti particle)', 'Type 3 (FE-ITO)', 'Type 4 (BP-Ioff)', 'Type 5 (BP-TD short)'],
        datasets: [{ data: [22, 25, 12, 38, 3], backgroundColor: ['#E67E22','#D35400','#F39C12','#2980B9','#1A5276'], borderWidth: 2, borderColor: '#fff' }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { position: 'right', labels: { font: { size: 10 }, padding: 8 } },
          datalabels: { formatter: v => v + '%', color: '#fff', font: { size: 10, weight: 'bold' } }
        }
      }
    });
  }

  // DD Types chart
  const ddCtx = document.getElementById('chartDDTypes');
  if (ddCtx) {
    if (charts.ddTypes) charts.ddTypes.destroy();
    charts.ddTypes = new Chart(ddCtx, {
      type: 'doughnut',
      data: {
        labels: ['Type 2 (Conductive particle)', 'Type 3 (PDL residue)', 'Type 4 (In-film particle)', 'No abn. FE (VIA open?)', 'No abn. BP'],
        datasets: [{ data: [27.3, 18.1, 27.3, 18.2, 9.1], backgroundColor: ['#2980B9','#1A5276','#5DADE2','#85C1E9','#AED6F1'], borderWidth: 2, borderColor: '#fff' }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { position: 'right', labels: { font: { size: 10 }, padding: 8 } },
          datalabels: { formatter: v => v.toFixed(1) + '%', color: '#fff', font: { size: 10, weight: 'bold' } }
        }
      }
    });
  }

  // CP Types chart
  const cpCtx = document.getElementById('chartCPTypes');
  if (cpCtx) {
    if (charts.cpTypes) charts.cpTypes.destroy();
    charts.cpTypes = new Chart(cpCtx, {
      type: 'doughnut',
      data: {
        labels: ['Leakage (Static IDD)', 'Short (Power)', 'GOA Circuit'],
        datasets: [{ data: [84.5, 11.3, 4.2], backgroundColor: ['#27AE60','#1E8449','#A9DFBF'], borderWidth: 2, borderColor: '#fff' }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { position: 'right', labels: { font: { size: 10 }, padding: 8 } },
          datalabels: { formatter: v => v + '%', color: '#fff', font: { size: 10, weight: 'bold' } }
        }
      }
    });
  }

  // VL Types chart
  const vlCtx = document.getElementById('chartVLTypes');
  if (vlCtx) {
    if (charts.vlTypes) charts.vlTypes.destroy();
    charts.vlTypes = new Chart(vlCtx, {
      type: 'doughnut',
      data: {
        labels: ['Bonding Resistance (ACF over-pressed)', 'BP CT Crosstalk'],
        datasets: [{ data: [83.9, 16.1], backgroundColor: ['#C0392B','#E74C3C'], borderWidth: 2, borderColor: '#fff' }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { position: 'right', labels: { font: { size: 10 }, padding: 8 } },
          datalabels: { formatter: v => v + '%', color: '#fff', font: { size: 10, weight: 'bold' } }
        }
      }
    });
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.addEventListener('DOMContentLoaded', () => {
  initFromSheets();

  renderDefectImages();
  loadData();
  // Sync loaded data back to inputs
  const bEl = document.getElementById('input-baseline');
  const aEl = document.getElementById('input-actual');
  const tEl = document.getElementById('input-target');
  if (bEl) bEl.value = appData.baseline;
  if (aEl) aEl.value = appData.actual;
  if (tEl) tEl.value = appData.target;
  updateAll();
  renderFACATable();
  renderFACAKPIs();
  // Auto-save every 30 seconds
  setInterval(saveData, 30000);
});

// Close modal on overlay click
document.getElementById('notesModal').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});

const FA_IMAGES = {
  s3: "https://files.manuscdn.com/user_upload_by_module/session_file/310519663388950090/HhbHVoIGBcpniAgB.jpg",
  s7: "https://files.manuscdn.com/user_upload_by_module/session_file/310519663388950090/hdnbuKnxiexiILKq.jpg",
  s8: "https://files.manuscdn.com/user_upload_by_module/session_file/310519663388950090/VkUcJnjxZUXZgQWc.jpg",
  s9: "https://files.manuscdn.com/user_upload_by_module/session_file/310519663388950090/XKzqVOPMXbjhoUCh.jpg",
  s11: "https://files.manuscdn.com/user_upload_by_module/session_file/310519663388950090/BGQGiVDHFsPnZOTn.jpg",
  s18: "https://files.manuscdn.com/user_upload_by_module/session_file/310519663388950090/acbZZzITcyDmHRqE.jpg",
  s21: "https://files.manuscdn.com/user_upload_by_module/session_file/310519663388950090/vJZhVvfmItnfANNX.jpg",
  s22: "https://files.manuscdn.com/user_upload_by_module/session_file/310519663388950090/MInHKkfgNPjmwrRk.jpg",
  s24: "https://files.manuscdn.com/user_upload_by_module/session_file/310519663388950090/FbpFBIaGfsWNOIly.jpg",
  s26: "https://files.manuscdn.com/user_upload_by_module/session_file/310519663388950090/bXjPFwlFpqdIUYub.jpg",
  s31: "https://files.manuscdn.com/user_upload_by_module/session_file/310519663388950090/ryxAvZjDbSaDealV.jpg",
  s34: "https://files.manuscdn.com/user_upload_by_module/session_file/310519663388950090/QAxPRCmmrKcsssEA.jpg",
};

function renderDefectImages() {
  (function() {
    var el = document.getElementById("imgs-panel-dd-bd");
    if (!el) return;
    el.innerHTML = [
      [FA_IMAGES.s3, "Slide 3: BD Inspection ‚Äî Optical Microscopy & Wafer/Die Mapping"],
      [FA_IMAGES.s7, "Slide 7: BD Type 1 ‚Äî CGL/Cathode Shunt SEM Cross-Section"],
      [FA_IMAGES.s8, "Slide 8: BD Type 2 ‚Äî Ti/OLED Particle SEM (P/T from SEM)"],
      [FA_IMAGES.s9, "Slide 9: BD Type 3 ‚Äî ITO Particle SEM & EDS Maps"],
      [FA_IMAGES.s11, "Slide 11: BD Type 5 ‚Äî High Brightness BD, TD Short SEM"],
    ].map(function(d) {
      return '<div class="fa-img-card"><div class="fa-img-title">' + d[1] + '</div><img src="' + d[0] + '" class="fa-img" loading="lazy" onclick="openFALightbox(this.src,this.alt)" alt="' + d[1] + '"></div>';
    }).join("");
  })();
  (function() {
    var el = document.getElementById("imgs-panel-dd-dd");
    if (!el) return;
    el.innerHTML = [
      [FA_IMAGES.s18, "Slide 18: DD Inspection ‚Äî Optical Microscopy & Wafer Mapping"],
      [FA_IMAGES.s21, "Slide 21: DD Type 1 ‚Äî VIA/Anode Open Hypothesis, FIB/SEM"],
      [FA_IMAGES.s22, "Slide 22: DD Type 2 ‚Äî Anode/Cathode Short FIB/SEM & EDS"],
      [FA_IMAGES.s24, "Slide 24: DD Type 4 ‚Äî In-Film Particle CF/OC/MLA/OCR"],
      [FA_IMAGES.s26, "Slide 26: Sony MIL FACA ‚Äî Ti Particle Root Cause & Fix"],
    ].map(function(d) {
      return '<div class="fa-img-card"><div class="fa-img-title">' + d[1] + '</div><img src="' + d[0] + '" class="fa-img" loading="lazy" onclick="openFALightbox(this.src,this.alt)" alt="' + d[1] + '"></div>';
    }).join("");
  })();
  (function() {
    var el = document.getElementById("imgs-panel-dd-vl");
    if (!el) return;
    el.innerHTML = [
      [FA_IMAGES.s31, "Slide 31: V-Line ‚Äî Optical Images & ACF Over-Pressed SEM"],
      [FA_IMAGES.s34, "Slide 34: LDO FPC Split-Screen FA ‚Äî ELVDD/VGH1 Short"],
    ].map(function(d) {
      return '<div class="fa-img-card"><div class="fa-img-title">' + d[1] + '</div><img src="' + d[0] + '" class="fa-img" loading="lazy" onclick="openFALightbox(this.src,this.alt)" alt="' + d[1] + '"></div>';
    }).join("");
  })();
}

function openFALightbox(src, label) {
  var lb = document.getElementById('fa-lightbox-overlay');
  if (!lb) {
    lb = document.createElement('div');
    lb.id = 'fa-lightbox-overlay';
    lb.setAttribute('style', 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.93);z-index:99999;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:zoom-out;padding:16px;box-sizing:border-box;');
    lb.innerHTML = '<div id="fa-lb-label" style="color:#fff;font-size:13px;font-weight:600;margin-bottom:10px;max-width:95%;text-align:center;line-height:1.4;"></div><img id="fa-lb-img" style="max-width:95vw;max-height:85vh;border-radius:6px;box-shadow:0 8px 40px rgba(0,0,0,0.9);object-fit:contain;" /><div style="color:#aaa;font-size:11px;margin-top:10px;">Click anywhere to close</div>';
    lb.addEventListener('click', function() { lb.style.display = 'none'; });
    document.body.appendChild(lb);
  }
  document.getElementById('fa-lb-label').textContent = label;
  document.getElementById('fa-lb-img').src = src;
  lb.style.display = 'flex';
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GOOGLE SHEETS API INTEGRATION
// Replace APPS_SCRIPT_URL with your deployed web app URL after deployment
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const APPS_SCRIPT_URL = 'https://script.google.com/a/macros/meta.com/s/AKfycbzd4Y2kFVfIDj5wjsX7SQ9zmsDad7bAL_4sbNeRUB6dW9Sy0GF8v0wKRTVJ-9ibasgv/exec';

// ‚îÄ‚îÄ Editor identity (populated on first load via Google Identity prompt) ‚îÄ‚îÄ
let currentEditor = { email: '', name: '' };

// ‚îÄ‚îÄ Detect if we have a real Apps Script URL configured ‚îÄ‚îÄ
function isConnected() {
  return APPS_SCRIPT_URL && APPS_SCRIPT_URL !== 'https://script.google.com/a/macros/meta.com/s/AKfycbzd4Y2kFVfIDj5wjsX7SQ9zmsDad7bAL_4sbNeRUB6dW9Sy0GF8v0wKRTVJ-9ibasgv/exec';
}

// ‚îÄ‚îÄ Show connection status badge ‚îÄ‚îÄ
function updateConnectionBadge() {
  const badge = document.getElementById('connection-badge');
  if (!badge) return;
  if (isConnected()) {
    badge.innerHTML = 'üü¢ Connected to Google Sheets';
    badge.style.background = '#d4edda';
    badge.style.color = '#155724';
  } else {
    badge.innerHTML = 'üü° Local mode (not connected to Google Sheets)';
    badge.style.background = '#fff3cd';
    badge.style.color = '#856404';
  }
}

// ‚îÄ‚îÄ API call helper ‚îÄ‚îÄ
async function apiGet(action) {
  const url = `${APPS_SCRIPT_URL}?action=${action}`;
  const resp = await fetch(url, { redirect: 'follow' });
  return resp.json();
}

async function apiPost(body) {
  const resp = await fetch(APPS_SCRIPT_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ ...body, editor: currentEditor }),
    redirect: 'follow',
  });
  return resp.json();
}

// ‚îÄ‚îÄ Initialize: load data from Sheets on page load ‚îÄ‚îÄ
async function initFromSheets() {
  if (!isConnected()) {
    console.log('Not connected to Google Sheets ‚Äî using localStorage');
    updateConnectionBadge();
    return;
  }

  // Ask for editor identity
  promptEditorIdentity();

  showLoadingOverlay('Loading data from Google Sheets...');
  try {
    // Initialize sheets if needed
    await apiGet('initSheets');

    // Load yield data
    const yieldResp = await apiGet('getYield');
    if (yieldResp.status === 'ok' && yieldResp.data) {
      applyYieldDataFromSheets(yieldResp.data);
    }

    // Load FACA data
    const facaResp = await apiGet('getFACA');
    if (facaResp.status === 'ok' && facaResp.data) {
      applyFACADataFromSheets(facaResp.data);
    }

    hideLoadingOverlay();
    updateConnectionBadge();
    updateAll();
    showToast('‚úÖ Data loaded from Google Sheets', 'success');
  } catch (err) {
    hideLoadingOverlay();
    showToast('‚ö†Ô∏è Could not reach Google Sheets ‚Äî using local data', 'warning');
    console.error('Sheets load error:', err);
    updateConnectionBadge();
  }
}

// ‚îÄ‚îÄ Apply yield data from Sheets to local state ‚îÄ‚îÄ
function applyYieldDataFromSheets(data) {
  if (data.baseline_yield)    state.baselineYield    = parseFloat(data.baseline_yield);
  if (data.evt2_actual_yield) state.evt2ActualYield  = parseFloat(data.evt2_actual_yield);
  if (data.target_yield)      state.targetYield      = parseFloat(data.target_yield);
  if (data.bd_ratio)          state.defects.BD.ratio = parseFloat(data.bd_ratio);
  if (data.dd_ratio)          state.defects.DD.ratio = parseFloat(data.dd_ratio);
  if (data.cp_ratio)          state.defects.CP.ratio = parseFloat(data.cp_ratio);
  if (data.tfe_ratio)         state.defects.TFE.ratio= parseFloat(data.tfe_ratio);
  if (data.vl_ratio)          state.defects.VL.ratio = parseFloat(data.vl_ratio);
  if (data.bd_fe_gain)        state.yieldBridge[0].gain = parseFloat(data.bd_fe_gain);
  if (data.bd_bp_gain)        state.yieldBridge[1].gain = parseFloat(data.bd_bp_gain);
  if (data.dd_fix_gain)       state.yieldBridge[2].gain = parseFloat(data.dd_fix_gain);
  if (data.cp_gain)           state.yieldBridge[3].gain = parseFloat(data.cp_gain);
  if (data.tfe_gain)          state.yieldBridge[4].gain = parseFloat(data.tfe_gain);
  if (data.vl_gain)           state.yieldBridge[5].gain = parseFloat(data.vl_gain);
}

// ‚îÄ‚îÄ Apply FACA data from Sheets to local state ‚îÄ‚îÄ
function applyFACADataFromSheets(data) {
  data.forEach(row => {
    const idx = state.facaActions.findIndex(a => a.id === row.id);
    if (idx !== -1) {
      if (row.status)    state.facaActions[idx].status    = row.status;
      if (row.owner)     state.facaActions[idx].owner     = row.owner;
      if (row.notes)     state.facaActions[idx].notes     = row.notes;
      if (row.yieldGain) state.facaActions[idx].gain      = parseFloat(row.yieldGain);
      if (row.checkpoint)state.facaActions[idx].checkpoint= row.checkpoint;
    }
  });
}

// ‚îÄ‚îÄ Save yield data to Sheets ‚îÄ‚îÄ
async function saveYieldToSheets() {
  if (!isConnected()) return;
  const data = {
    baseline_yield:    String(state.baselineYield),
    evt2_actual_yield: String(state.evt2ActualYield),
    target_yield:      String(state.targetYield),
    bd_ratio:          String(state.defects.BD.ratio),
    dd_ratio:          String(state.defects.DD.ratio),
    cp_ratio:          String(state.defects.CP.ratio),
    tfe_ratio:         String(state.defects.TFE.ratio),
    vl_ratio:          String(state.defects.VL.ratio),
    bd_fe_gain:        String(state.yieldBridge[0].gain),
    bd_bp_gain:        String(state.yieldBridge[1].gain),
    dd_fix_gain:       String(state.yieldBridge[2].gain),
    cp_gain:           String(state.yieldBridge[3].gain),
    tfe_gain:          String(state.yieldBridge[4].gain),
    vl_gain:           String(state.yieldBridge[5].gain),
  };
  try {
    const result = await apiPost({ action: 'saveYield', data });
    if (result.changes > 0) {
      showToast(`‚úÖ ${result.changes} yield value(s) saved to Google Sheets`, 'success');
    }
  } catch (err) {
    showToast('‚ö†Ô∏è Could not save to Google Sheets', 'warning');
  }
}

// ‚îÄ‚îÄ Save a single FACA row to Sheets ‚îÄ‚îÄ
async function saveFACARowToSheets(actionId) {
  if (!isConnected()) return;
  const action = state.facaActions.find(a => a.id === actionId);
  if (!action) return;
  try {
    await apiPost({
      action: 'updateFACARow',
      row: {
        id:         action.id,
        status:     action.status,
        owner:      action.owner     || '',
        notes:      action.notes     || '',
        yieldGain:  String(action.gain),
        checkpoint: action.checkpoint || '',
      }
    });
  } catch (err) {
    console.error('FACA save error:', err);
  }
}

// ‚îÄ‚îÄ Load and display the change log ‚îÄ‚îÄ
async function loadChangeLog() {
  if (!isConnected()) {
    document.getElementById('changelog-container').innerHTML =
      '<div style="color:#856404;background:#fff3cd;padding:16px;border-radius:8px;">‚ö†Ô∏è Change log requires Google Sheets connection. Please configure the Apps Script URL.</div>';
    return;
  }
  document.getElementById('changelog-container').innerHTML =
    '<div style="color:#888;padding:16px;">Loading change log...</div>';
  try {
    const resp = await apiGet('getLog');
    renderChangeLog(resp.data || []);
  } catch (err) {
    document.getElementById('changelog-container').innerHTML =
      '<div style="color:#721c24;background:#f8d7da;padding:16px;border-radius:8px;">‚ùå Failed to load change log: ' + err.message + '</div>';
  }
}

function renderChangeLog(entries) {
  const container = document.getElementById('changelog-container');
  if (!entries.length) {
    container.innerHTML = '<div style="color:#888;padding:16px;font-style:italic;">No changes recorded yet.</div>';
    return;
  }
  const rows = entries.slice(0, 100).map(e => {
    const ts = e.timestamp ? new Date(e.timestamp).toLocaleString() : '';
    return `<tr>
      <td style="white-space:nowrap;">${ts}</td>
      <td style="color:#1F3864;font-weight:600;">${e.email || ''}</td>
      <td>${e.sheet || ''}</td>
      <td>${e.field || ''}</td>
      <td style="color:#721c24;">${e.oldValue !== undefined ? e.oldValue : ''}</td>
      <td style="color:#155724;">${e.newValue !== undefined ? e.newValue : ''}</td>
    </tr>`;
  }).join('');
  container.innerHTML = `
    <div style="overflow-x:auto;">
      <table style="width:100%;border-collapse:collapse;font-size:12px;">
        <thead>
          <tr style="background:#1F3864;color:#fff;">
            <th style="padding:8px;text-align:left;">Timestamp</th>
            <th style="padding:8px;text-align:left;">Editor Email</th>
            <th style="padding:8px;text-align:left;">Sheet</th>
            <th style="padding:8px;text-align:left;">Field Changed</th>
            <th style="padding:8px;text-align:left;">Old Value</th>
            <th style="padding:8px;text-align:left;">New Value</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
    <div style="color:#888;font-size:11px;margin-top:8px;">Showing last ${Math.min(entries.length,100)} of ${entries.length} changes</div>`;
}

// ‚îÄ‚îÄ Editor identity prompt ‚îÄ‚îÄ
function promptEditorIdentity() {
  // Check if already set
  const saved = localStorage.getItem('oled_editor');
  if (saved) {
    try { currentEditor = JSON.parse(saved); return; } catch(e) {}
  }
  // Show modal
  const modal = document.getElementById('editor-modal');
  if (modal) modal.style.display = 'flex';
}

function saveEditorIdentity() {
  const emailEl = document.getElementById('editor-email-input');
  const nameEl  = document.getElementById('editor-name-input');
  const email = emailEl ? emailEl.value.trim() : '';
  const name  = nameEl  ? nameEl.value.trim()  : email;
  if (!email) { alert('Please enter your email address.'); return; }
  currentEditor = { email, name: name || email };
  localStorage.setItem('oled_editor', JSON.stringify(currentEditor));
  const modal = document.getElementById('editor-modal');
  if (modal) modal.style.display = 'none';
  document.getElementById('current-editor-display') &&
    (document.getElementById('current-editor-display').textContent = `Editing as: ${currentEditor.email}`);
  showToast(`üë§ Signed in as ${currentEditor.email}`, 'success');
}

// ‚îÄ‚îÄ Loading overlay ‚îÄ‚îÄ
function showLoadingOverlay(msg) {
  let el = document.getElementById('loading-overlay');
  if (!el) {
    el = document.createElement('div');
    el.id = 'loading-overlay';
    el.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(31,56,100,0.85);z-index:99998;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff;font-size:16px;font-weight:600;';
    el.innerHTML = '<div style="font-size:32px;margin-bottom:16px;">‚è≥</div><div id="loading-msg"></div>';
    document.body.appendChild(el);
  }
  document.getElementById('loading-msg').textContent = msg || 'Loading...';
  el.style.display = 'flex';
}

function hideLoadingOverlay() {
  const el = document.getElementById('loading-overlay');
  if (el) el.style.display = 'none';
}

// ‚îÄ‚îÄ Toast notification ‚îÄ‚îÄ
function showToast(msg, type) {
  let container = document.getElementById('toast-container');
  if (!container) {
    container = document.createElement('div');
    container.id = 'toast-container';
    container.style.cssText = 'position:fixed;bottom:24px;right:24px;z-index:99999;display:flex;flex-direction:column;gap:8px;';
    document.body.appendChild(container);
  }
  const colors = { success: '#d4edda', warning: '#fff3cd', error: '#f8d7da' };
  const textColors = { success: '#155724', warning: '#856404', error: '#721c24' };
  const toast = document.createElement('div');
  toast.style.cssText = `background:${colors[type]||'#e2e3e5'};color:${textColors[type]||'#383d41'};padding:12px 20px;border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,0.15);font-size:13px;font-weight:600;max-width:360px;animation:slideIn 0.3s ease;`;
  toast.textContent = msg;
  container.appendChild(toast);
  setTimeout(() => { toast.style.opacity = '0'; toast.style.transition = 'opacity 0.5s'; setTimeout(() => toast.remove(), 500); }, 4000);
}



// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// APPROVAL WORKFLOW & IMAGE MANAGEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ Pending change buffer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let pendingChangeBuffer = null; // stores change details before modal confirm

// ‚îÄ‚îÄ Intercept yield/FACA changes ‚Üí submit for approval ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const _origUpdateCAStatus = updateCAStatus;
updateCAStatus = function(id, val) {
  const a = appData.caActions.find(x => x.id === id);
  if (!a) return;
  if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL.includes('PASTE_YOUR')) {
    // Local mode: apply directly
    _origUpdateCAStatus(id, val);
    return;
  }
  // Check if current user is approver ‚Üí if yes, apply directly
  if (currentUserIsApprover) {
    _origUpdateCAStatus(id, val);
    syncToSheets();
    return;
  }
  // Otherwise submit for approval
  openChangeModal({
    changeType: 'faca',
    field: id + '.status',
    oldValue: a.status,
    newValue: val,
    label: a.label + ' ‚Üí Status',
    displayOld: a.status,
    displayNew: val
  });
};

const _origUpdateCAGain = updateCAGain;
updateCAGain = function(id, val) {
  const a = appData.caActions.find(x => x.id === id);
  if (!a) return;
  if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL.includes('PASTE_YOUR')) {
    _origUpdateCAGain(id, val);
    return;
  }
  if (currentUserIsApprover) {
    _origUpdateCAGain(id, val);
    syncToSheets();
    return;
  }
  openChangeModal({
    changeType: 'faca',
    field: id + '.gain',
    oldValue: a.gain,
    newValue: parseFloat(val),
    label: a.label + ' ‚Üí Expected Gain',
    displayOld: a.gain + '%',
    displayNew: val + '%'
  });
};

// ‚îÄ‚îÄ Change Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openChangeModal(changeDetails) {
  pendingChangeBuffer = changeDetails;
  const modal = document.getElementById('change-submit-modal');
  const details = document.getElementById('change-submit-details');
  details.innerHTML = `
    <div style="margin-bottom:8px;"><strong>Field:</strong> ${changeDetails.label || changeDetails.field}</div>
    <div style="margin-bottom:4px;"><strong>Current value:</strong> <span style="color:#C0392B;">${changeDetails.displayOld || changeDetails.oldValue}</span></div>
    <div><strong>New value:</strong> <span style="color:#2E7D32;">${changeDetails.displayNew || changeDetails.newValue}</span></div>
  `;
  document.getElementById('change-reason').value = '';
  modal.style.display = 'flex';
}

function closeChangeModal() {
  document.getElementById('change-submit-modal').style.display = 'none';
  pendingChangeBuffer = null;
}

async function confirmSubmitChange() {
  if (!pendingChangeBuffer) return;
  const reason = document.getElementById('change-reason').value.trim();
  const btn = document.querySelector('#change-submit-modal button[onclick="confirmSubmitChange()"]');
  btn.textContent = 'Submitting...';
  btn.disabled = true;

  try {
    const payload = {
      action: 'submitChange',
      submitterEmail: currentUserEmail || 'unknown@meta.com',
      submitterName: currentUserName || currentUserEmail || 'Unknown',
      changeType: pendingChangeBuffer.changeType,
      field: pendingChangeBuffer.field,
      oldValue: pendingChangeBuffer.oldValue,
      newValue: pendingChangeBuffer.newValue,
      reason: reason
    };
    const res = await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (data.success) {
      showToast('‚úÖ Change submitted for approval (ID: ' + data.changeId + '). An approver will be notified by email.', 'success', 5000);
    } else {
      showToast('‚ùå Error: ' + (data.error || 'Unknown error'), 'error');
    }
  } catch(e) {
    showToast('‚ùå Network error. Please try again.', 'error');
  }

  btn.textContent = 'Submit for Approval';
  btn.disabled = false;
  closeChangeModal();
}

// ‚îÄ‚îÄ Approval Queue ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentUserIsApprover = false;

async function loadPendingChanges() {
  if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL.includes('PASTE_YOUR')) {
    document.getElementById('pending-list').innerHTML = '<div style="text-align:center;color:#6c757d;padding:40px;">Connect to Google Sheets to use the approval workflow.</div>';
    return;
  }
  document.getElementById('pending-list').innerHTML = '<div style="text-align:center;color:#6c757d;padding:40px;">Loading...</div>';
  try {
    const res = await fetch(APPS_SCRIPT_URL + '?action=getPending');
    const data = await res.json();
    renderPendingList(data.pending || []);
    updatePendingBadge(data.pending ? data.pending.length : 0);

    // Load history
    const logRes = await fetch(APPS_SCRIPT_URL + '?action=getChangelog');
    const logData = await logRes.json();
    renderApprovalHistory(logData.log || []);
  } catch(e) {
    document.getElementById('pending-list').innerHTML = '<div style="color:#C0392B;padding:20px;">Error loading pending changes: ' + e.message + '</div>';
  }
}

function renderPendingList(pending) {
  const container = document.getElementById('pending-list');
  if (!pending.length) {
    container.innerHTML = '<div style="text-align:center;color:#6c757d;padding:40px;background:#fff;border-radius:10px;border:1px solid #dee2e6;">‚úÖ No pending changes. All changes are up to date.</div>';
    return;
  }

  container.innerHTML = pending.map(p => `
    <div style="background:#fff;border-radius:10px;border:1px solid #ffc107;border-left:4px solid #ffc107;padding:18px;margin-bottom:14px;box-shadow:0 2px 8px rgba(0,0,0,0.06);">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:10px;">
        <div>
          <div style="font-size:12px;color:#6c757d;margin-bottom:4px;">Change ID: ${p.id} ¬∑ Submitted: ${new Date(p.timestamp).toLocaleString()}</div>
          <div style="font-weight:600;color:#1F3864;margin-bottom:6px;">${p.field}</div>
          <div style="font-size:13px;margin-bottom:4px;">
            <span style="color:#6c757d;">Submitted by:</span> <strong>${p.submitterName}</strong> (${p.submitterEmail})
          </div>
          <div style="font-size:13px;margin-bottom:4px;">
            <span style="color:#C0392B;">Old value:</span> <strong>${p.oldValue}</strong>
            &nbsp;‚Üí&nbsp;
            <span style="color:#2E7D32;">New value:</span> <strong>${p.newValue}</strong>
          </div>
          ${p.reason ? '<div style="font-size:13px;color:#6c757d;margin-top:4px;"><em>Reason: ' + p.reason + '</em></div>' : ''}
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          ${currentUserIsApprover ? `
            <button onclick="approveChange('${p.id}')" style="background:#2E7D32;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;">‚úÖ Approve</button>
            <button onclick="rejectChangePrompt('${p.id}')" style="background:#C0392B;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;">‚ùå Reject</button>
          ` : '<span style="color:#6c757d;font-size:12px;">View only</span>'}
        </div>
      </div>
    </div>
  `).join('');
}

function renderApprovalHistory(log) {
  const container = document.getElementById('approval-history');
  const relevant = log.filter(l => ['Change Approved','Change Rejected','Change Submitted'].includes(l.action)).slice(0, 20);
  if (!relevant.length) {
    container.innerHTML = '<div style="color:#6c757d;padding:20px;text-align:center;">No approval history yet.</div>';
    return;
  }
  container.innerHTML = `<table style="width:100%;border-collapse:collapse;font-size:13px;background:#fff;border-radius:8px;overflow:hidden;border:1px solid #dee2e6;">
    <thead><tr style="background:#1F3864;color:#fff;">
      <th style="padding:10px;text-align:left;">Time</th>
      <th style="padding:10px;text-align:left;">Action</th>
      <th style="padding:10px;text-align:left;">By</th>
      <th style="padding:10px;text-align:left;">Field</th>
      <th style="padding:10px;text-align:left;">Value</th>
    </tr></thead>
    <tbody>${relevant.map((l,i) => `
      <tr style="background:${i%2===0?'#f8f9fa':'#fff'};">
        <td style="padding:9px 10px;color:#6c757d;">${new Date(l.timestamp).toLocaleString()}</td>
        <td style="padding:9px 10px;">
          <span style="background:${l.action.includes('Approved')?'#d4edda':l.action.includes('Rejected')?'#f8d7da':'#fff3cd'};
            color:${l.action.includes('Approved')?'#155724':l.action.includes('Rejected')?'#721c24':'#856404'};
            padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600;">${l.action}</span>
        </td>
        <td style="padding:9px 10px;">${l.email}</td>
        <td style="padding:9px 10px;">${l.field}</td>
        <td style="padding:9px 10px;">${l.newValue || l.oldValue || '‚Äî'}</td>
      </tr>
    `).join('')}</tbody>
  </table>`;
}

async function approveChange(changeId) {
  if (!confirm('Approve this change? It will be applied immediately.')) return;
  try {
    const res = await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'approveChange', changeId, approverEmail: currentUserEmail })
    });
    const data = await res.json();
    if (data.success) {
      showToast('‚úÖ Change approved and applied.', 'success');
      loadPendingChanges();
      loadData(); // refresh tracker data
    } else {
      showToast('‚ùå ' + (data.error || 'Error approving change'), 'error');
    }
  } catch(e) {
    showToast('‚ùå Network error: ' + e.message, 'error');
  }
}

async function rejectChangePrompt(changeId) {
  const reason = prompt('Reason for rejection (optional):') || '';
  try {
    const res = await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'rejectChange', changeId, approverEmail: currentUserEmail, reason })
    });
    const data = await res.json();
    if (data.success) {
      showToast('Change rejected.', 'info');
      loadPendingChanges();
    } else {
      showToast('‚ùå ' + (data.error || 'Error rejecting change'), 'error');
    }
  } catch(e) {
    showToast('‚ùå Network error: ' + e.message, 'error');
  }
}

function updatePendingBadge(count) {
  const badge = document.getElementById('pending-badge');
  if (!badge) return;
  if (count > 0) {
    badge.style.display = 'inline';
    badge.textContent = count;
  } else {
    badge.style.display = 'none';
  }
}

// ‚îÄ‚îÄ Admin Panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadAdminPanel() {
  // Set script URL
  const urlInput = document.getElementById('admin-script-url');
  if (urlInput) urlInput.value = APPS_SCRIPT_URL || '';

  if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL.includes('PASTE_YOUR')) {
    document.getElementById('approver-list').innerHTML = '<div style="color:#6c757d;">Connect to Google Sheets first.</div>';
    return;
  }

  // Load approvers
  try {
    const res = await fetch(APPS_SCRIPT_URL + '?action=getApprovers');
    const data = await res.json();
    renderApproverList(data.approvers || []);
  } catch(e) {
    document.getElementById('approver-list').innerHTML = '<div style="color:#C0392B;">Error loading approvers.</div>';
  }

  // Load image archive
  try {
    const res = await fetch(APPS_SCRIPT_URL + '?action=getImages');
    const data = await res.json();
    const archived = (data.images || []).filter(img => img.archived);
    renderImageArchive(archived);
  } catch(e) {
    document.getElementById('image-archive-list').innerHTML = '<div style="color:#C0392B;">Error loading archive.</div>';
  }
}

function renderApproverList(approvers) {
  const container = document.getElementById('approver-list');
  if (!approvers.length) {
    container.innerHTML = '<div style="color:#6c757d;padding:10px;">No approvers configured.</div>';
    return;
  }
  container.innerHTML = `<table style="width:100%;border-collapse:collapse;font-size:13px;margin-bottom:12px;">
    <thead><tr style="background:#f8f9fa;">
      <th style="padding:8px;text-align:left;border-bottom:1px solid #dee2e6;">Email</th>
      <th style="padding:8px;text-align:left;border-bottom:1px solid #dee2e6;">Added By</th>
      <th style="padding:8px;text-align:left;border-bottom:1px solid #dee2e6;">Added At</th>
      <th style="padding:8px;border-bottom:1px solid #dee2e6;"></th>
    </tr></thead>
    <tbody>${approvers.map(a => `
      <tr>
        <td style="padding:8px;border-bottom:1px solid #f0f0f0;">${a.email}</td>
        <td style="padding:8px;border-bottom:1px solid #f0f0f0;color:#6c757d;">${a.addedBy}</td>
        <td style="padding:8px;border-bottom:1px solid #f0f0f0;color:#6c757d;">${new Date(a.addedAt).toLocaleDateString()}</td>
        <td style="padding:8px;border-bottom:1px solid #f0f0f0;">
          ${a.email !== currentUserEmail ? `<button onclick="removeApprover('${a.email}')" style="background:#C0392B;color:#fff;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;font-size:12px;">Remove</button>` : '<span style="color:#6c757d;font-size:12px;">(you)</span>'}
        </td>
      </tr>
    `).join('')}</tbody>
  </table>`;
}

async function addApprover() {
  const email = document.getElementById('new-approver-email').value.trim();
  if (!email) { showToast('Please enter an email address', 'error'); return; }
  try {
    const res = await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'addApprover', newApproverEmail: email, requesterEmail: currentUserEmail })
    });
    const data = await res.json();
    if (data.success) {
      showToast('‚úÖ ' + email + ' added as approver', 'success');
      document.getElementById('new-approver-email').value = '';
      loadAdminPanel();
    } else {
      showToast('‚ùå ' + (data.error || 'Error'), 'error');
    }
  } catch(e) {
    showToast('‚ùå Network error', 'error');
  }
}

async function removeApprover(email) {
  if (!confirm('Remove ' + email + ' as approver?')) return;
  try {
    const res = await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'removeApprover', targetEmail: email, requesterEmail: currentUserEmail })
    });
    const data = await res.json();
    if (data.success) {
      showToast('Approver removed.', 'info');
      loadAdminPanel();
    } else {
      showToast('‚ùå ' + (data.error || 'Error'), 'error');
    }
  } catch(e) {
    showToast('‚ùå Network error', 'error');
  }
}

function updateScriptUrl() {
  const url = document.getElementById('admin-script-url').value.trim();
  if (!url) return;
  APPS_SCRIPT_URL = url;
  localStorage.setItem('oled_script_url', url);
  showToast('‚úÖ Apps Script URL updated', 'success');
}

// ‚îÄ‚îÄ Image Archive ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderImageArchive(archived) {
  const container = document.getElementById('image-archive-list');
  if (!archived.length) {
    container.innerHTML = '<div style="color:#6c757d;padding:10px;">No archived images.</div>';
    return;
  }
  container.innerHTML = archived.map(img => `
    <div style="display:flex;align-items:center;gap:12px;padding:10px;border-bottom:1px solid #f0f0f0;">
      <img src="${img.thumbnailUrl}" style="width:60px;height:45px;object-fit:cover;border-radius:4px;border:1px solid #dee2e6;">
      <div style="flex:1;">
        <div style="font-weight:600;font-size:13px;">${img.filename}</div>
        <div style="font-size:12px;color:#6c757d;">Category: ${img.category} ¬∑ Archived by ${img.archivedBy} on ${new Date(img.archivedAt).toLocaleDateString()}</div>
        ${img.caption ? '<div style="font-size:12px;color:#495057;">' + img.caption + '</div>' : ''}
      </div>
      <button onclick="restoreImage('${img.id}')" style="background:#2E7D32;color:#fff;border:none;padding:6px 14px;border-radius:6px;cursor:pointer;font-size:12px;">Restore</button>
    </div>
  `).join('');
}

async function restoreImage(imageId) {
  try {
    const res = await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'restoreImage', imageId, userEmail: currentUserEmail })
    });
    const data = await res.json();
    if (data.success) {
      showToast('‚úÖ Image restored', 'success');
      loadAdminPanel();
      renderDriveImages(currentImageCategory);
    } else {
      showToast('‚ùå ' + (data.error || 'Error'), 'error');
    }
  } catch(e) {
    showToast('‚ùå Network error', 'error');
  }
}

// ‚îÄ‚îÄ Image Upload ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentImageCategory = 'BD';
let uploadFileData = null;
let uploadFileName = null;
let uploadMimeType = null;

function openImageUploadModal(category) {
  currentImageCategory = category;
  document.getElementById('upload-category-label').textContent = category + ' defect category';
  document.getElementById('upload-caption').value = '';
  document.getElementById('upload-preview').style.display = 'none';
  document.getElementById('upload-file-input').value = '';
  uploadFileData = null;
  document.getElementById('image-upload-modal').style.display = 'flex';
}

function closeImageUploadModal() {
  document.getElementById('image-upload-modal').style.display = 'none';
}

function handleImageFileSelect(event) {
  const file = event.target.files[0];
  if (file) processImageFile(file);
}

function handleImageDrop(event) {
  event.preventDefault();
  document.getElementById('upload-drop-zone').style.borderColor = '#dee2e6';
  const file = event.dataTransfer.files[0];
  if (file) processImageFile(file);
}

function processImageFile(file) {
  if (file.size > 5 * 1024 * 1024) {
    showToast('File too large. Maximum size is 5 MB.', 'error');
    return;
  }
  uploadFileName = file.name;
  uploadMimeType = file.type;
  const reader = new FileReader();
  reader.onload = function(e) {
    uploadFileData = e.target.result; // base64 data URL
    const preview = document.getElementById('upload-preview');
    const img = document.getElementById('upload-preview-img');
    img.src = uploadFileData;
    preview.style.display = 'block';
  };
  reader.readAsDataURL(file);
}

async function confirmImageUpload() {
  if (!uploadFileData) {
    showToast('Please select an image file first.', 'error');
    return;
  }
  if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL.includes('PASTE_YOUR')) {
    showToast('Connect to Google Sheets to upload images to Drive.', 'error');
    return;
  }
  const btn = document.getElementById('upload-confirm-btn');
  btn.textContent = 'Uploading...';
  btn.disabled = true;

  try {
    const res = await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify({
        action: 'uploadImage',
        category: currentImageCategory,
        imageData: uploadFileData,
        mimeType: uploadMimeType,
        filename: uploadFileName,
        caption: document.getElementById('upload-caption').value.trim(),
        uploaderEmail: currentUserEmail || 'unknown'
      })
    });
    const data = await res.json();
    if (data.success) {
      showToast('‚úÖ Image uploaded to Google Drive successfully!', 'success', 4000);
      closeImageUploadModal();
      renderDriveImages(currentImageCategory);
    } else {
      showToast('‚ùå Upload failed: ' + (data.error || 'Unknown error'), 'error');
    }
  } catch(e) {
    showToast('‚ùå Network error: ' + e.message, 'error');
  }

  btn.textContent = 'Upload to Drive';
  btn.disabled = false;
}

// ‚îÄ‚îÄ Render Drive Images in Defect Detail panels ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function renderDriveImages(category) {
  if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL.includes('PASTE_YOUR')) return;
  const containerId = 'drive-imgs-' + category.toLowerCase();
  const container = document.getElementById(containerId);
  if (!container) return;

  container.innerHTML = '<div style="color:#6c757d;font-size:13px;padding:10px;">Loading Drive images...</div>';
  try {
    const res = await fetch(APPS_SCRIPT_URL + '?action=getImages&category=' + category);
    const data = await res.json();
    const active = (data.images || []).filter(img => !img.archived);
    if (!active.length) {
      container.innerHTML = '<div style="color:#6c757d;font-size:13px;padding:10px;">No images uploaded yet for this category.</div>';
      return;
    }
    container.innerHTML = active.map(img => `
      <div style="display:inline-block;vertical-align:top;width:180px;margin:8px;text-align:center;background:#fff;border-radius:8px;border:1px solid #dee2e6;padding:10px;box-shadow:0 2px 6px rgba(0,0,0,0.06);">
        <img src="${img.thumbnailUrl}" onclick="openFALightbox('${img.driveUrl}', '${img.caption || img.filename}')"
          style="width:100%;height:120px;object-fit:cover;border-radius:4px;cursor:pointer;margin-bottom:6px;">
        <div style="font-size:11px;color:#495057;margin-bottom:4px;">${img.caption || img.filename}</div>
        <div style="font-size:10px;color:#adb5bd;margin-bottom:6px;">By ${img.uploadedBy.split('@')[0]}</div>
        <button onclick="archiveImage('${img.id}', '${category}')"
          style="background:#f8d7da;color:#721c24;border:1px solid #f5c6cb;padding:3px 10px;border-radius:4px;cursor:pointer;font-size:11px;">üóë Archive</button>
      </div>
    `).join('');
  } catch(e) {
    container.innerHTML = '<div style="color:#C0392B;font-size:13px;padding:10px;">Error loading images.</div>';
  }
}

async function archiveImage(imageId, category) {
  if (!confirm('Move this image to the archive? You can restore it from the Admin panel.')) return;
  try {
    const res = await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'deleteImage', imageId, userEmail: currentUserEmail })
    });
    const data = await res.json();
    if (data.success) {
      showToast('Image moved to archive.', 'info');
      renderDriveImages(category);
    } else {
      showToast('‚ùå ' + (data.error || 'Error'), 'error');
    }
  } catch(e) {
    showToast('‚ùå Network error', 'error');
  }
}

// ‚îÄ‚îÄ Toast notification ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showToast(message, type = 'info', duration = 3500) {
  const existing = document.getElementById('toast-notification');
  if (existing) existing.remove();
  const colors = { success: '#2E7D32', error: '#C0392B', info: '#1F3864', warning: '#E67E22' };
  const toast = document.createElement('div');
  toast.id = 'toast-notification';
  toast.style.cssText = `position:fixed;bottom:24px;right:24px;background:${colors[type]||colors.info};color:#fff;padding:14px 20px;border-radius:8px;font-size:14px;font-weight:500;z-index:9999;box-shadow:0 4px 20px rgba(0,0,0,0.25);max-width:400px;line-height:1.4;`;
  toast.textContent = message;
  document.body.appendChild(toast);
  setTimeout(() => { if (toast.parentNode) toast.remove(); }, duration);
}

// ‚îÄ‚îÄ Check approver status on load ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function checkApproverStatus() {
  if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL.includes('PASTE_YOUR')) return;
  try {
    const res = await fetch(APPS_SCRIPT_URL + '?action=getApprovers');
    const data = await res.json();
    const approvers = data.approvers || [];
    currentUserIsApprover = approvers.some(a => a.email === currentUserEmail);
    const banner = document.getElementById('approver-banner');
    if (banner) banner.style.display = currentUserIsApprover ? 'none' : 'block';

    // Load pending count for badge
    const pendingRes = await fetch(APPS_SCRIPT_URL + '?action=getPending');
    const pendingData = await pendingRes.json();
    updatePendingBadge((pendingData.pending || []).length);
  } catch(e) {
    // Silently fail
  }
}

// ‚îÄ‚îÄ Hook into showPage to load data on navigation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const _origShowPage = showPage;
showPage = function(pageId) {
  _origShowPage(pageId);
  if (pageId === 'approval-queue') loadPendingChanges();
  if (pageId === 'admin-panel') loadAdminPanel();
};

// ‚îÄ‚îÄ Add image upload buttons to defect detail panels ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function injectImageUploadButtons() {
  const categories = ['BD', 'DD', 'CP', 'TFE', 'VL'];
  const panelIds = {
    BD: 'imgs-panel-dd-bd',
    DD: 'imgs-panel-dd-dd',
    CP: 'imgs-panel-dd-cp',
    TFE: 'imgs-panel-dd-tfe',
    VL: 'imgs-panel-dd-vl'
  };

  for (const cat of categories) {
    const panelId = panelIds[cat];
    const panel = document.getElementById(panelId);
    if (!panel) continue;

    // Add Drive images container + upload button after the panel
    const wrapper = document.createElement('div');
    wrapper.style.cssText = 'margin-top:20px;';
    wrapper.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <h4 style="color:#1F3864;margin:0;">üìÅ Team-Uploaded FA Images (Google Drive)</h4>
        <button onclick="openImageUploadModal('${cat}')"
          style="background:#2E7D32;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;">
          + Upload Image
        </button>
      </div>
      <div id="drive-imgs-${cat.toLowerCase()}" style="min-height:60px;background:#f8f9fa;border-radius:8px;border:1px dashed #dee2e6;padding:8px;">
        <div style="color:#6c757d;font-size:13px;padding:10px;">
          ${APPS_SCRIPT_URL && !APPS_SCRIPT_URL.includes('PASTE_YOUR') ? 'Loading...' : 'Connect to Google Sheets to enable Drive image uploads.'}
        </div>
      </div>
    `;
    panel.parentNode.insertBefore(wrapper, panel.nextSibling);

    // Load drive images
    if (APPS_SCRIPT_URL && !APPS_SCRIPT_URL.includes('PASTE_YOUR')) {
      renderDriveImages(cat);
    }
  }
}

// ‚îÄ‚îÄ Initialize on DOMContentLoaded ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded', function() {
  // Restore script URL from localStorage if saved
  const savedUrl = localStorage.getItem('oled_script_url');
  if (savedUrl) APPS_SCRIPT_URL = savedUrl;

  // Inject upload buttons after a short delay to ensure panels are rendered
  setTimeout(() => {
    injectImageUploadButtons();
    checkApproverStatus();
  }, 1500);
});

</script>

<div id="editor-modal">
  <div class="editor-modal-box">
    <div class="editor-modal-title">üë§ Identify Yourself</div>
    <div class="editor-modal-sub">
      This tracker is connected to Google Sheets. Your Meta email will be recorded
      in the change log whenever you update yield data or FACA status.
    </div>
    <input type="email" id="editor-email-input" class="editor-input"
           placeholder="your.name@meta.com" />
    <input type="text" id="editor-name-input" class="editor-input"
           placeholder="Your Name (optional)" />
    <button onclick="saveEditorIdentity()"
            style="width:100%;padding:12px;background:#1F3864;color:#fff;border:none;border-radius:6px;font-size:14px;font-weight:600;cursor:pointer;">
      Continue ‚Üí
    </button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- APPROVAL QUEUE PAGE                                             -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="page-approval-queue" class="page" style=" padding:24px; max-width:1200px; margin:0 auto;">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
    <div>
      <h2 style="color:#1F3864; margin:0;">üîî Approval Queue</h2>
      <p style="color:#6c757d; margin:4px 0 0 0;">Review and approve or reject pending changes submitted by team members.</p>
    </div>
    <button onclick="loadPendingChanges()" style="background:#1F3864;color:#fff;border:none;padding:10px 18px;border-radius:6px;cursor:pointer;font-size:14px;">‚Ü∫ Refresh</button>
  </div>

  <!-- Approver check banner -->
  <div id="approver-banner" style="display:none; background:#fff3cd; border:1px solid #ffc107; border-radius:8px; padding:14px 18px; margin-bottom:20px; color:#856404;">
    ‚ö†Ô∏è You are not listed as an approver. You can view pending changes but cannot approve or reject them. Contact an admin to be added as an approver.
  </div>

  <!-- Pending changes list -->
  <div id="pending-list" style="margin-bottom:32px;">
    <div style="text-align:center; color:#6c757d; padding:40px;">Loading pending changes...</div>
  </div>

  <!-- History section -->
  <h3 style="color:#1F3864; border-bottom:2px solid #1F3864; padding-bottom:8px;">üìú Recent Approval History</h3>
  <div id="approval-history" style="color:#6c757d; padding:20px; text-align:center;">Loading history...</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- ADMIN PANEL PAGE                                                -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="page-admin-panel" class="page" style=" padding:24px; max-width:900px; margin:0 auto;">
  <h2 style="color:#1F3864; margin:0 0 6px 0;">‚öôÔ∏è Admin Panel</h2>
  <p style="color:#6c757d; margin:0 0 24px 0;">Manage approvers, view system settings, and configure the tracker.</p>

  <!-- Approver Management -->
  <div style="background:#fff; border-radius:10px; border:1px solid #dee2e6; padding:20px; margin-bottom:20px;">
    <h3 style="color:#1F3864; margin:0 0 16px 0;">üë• Approver Management</h3>
    <p style="color:#6c757d; font-size:13px; margin-bottom:16px;">Approvers can approve or reject change requests submitted by team members. Only existing approvers can add or remove others.</p>
    <div id="approver-list" style="margin-bottom:16px;">Loading approvers...</div>
    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
      <input type="email" id="new-approver-email" placeholder="new.approver@meta.com"
        style="flex:1; min-width:220px; padding:10px 14px; border:1px solid #dee2e6; border-radius:6px; font-size:14px;">
      <button onclick="addApprover()" style="background:#2E7D32;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-size:14px;white-space:nowrap;">+ Add Approver</button>
    </div>
  </div>

  <!-- Apps Script URL -->
  <div style="background:#fff; border-radius:10px; border:1px solid #dee2e6; padding:20px; margin-bottom:20px;">
    <h3 style="color:#1F3864; margin:0 0 12px 0;">üîó Apps Script Connection</h3>
    <p style="color:#6c757d; font-size:13px; margin-bottom:12px;">The URL of the deployed Google Apps Script web app. Update this if you redeploy.</p>
    <div style="display:flex; gap:10px; align-items:center;">
      <input type="url" id="admin-script-url" style="flex:1; padding:10px 14px; border:1px solid #dee2e6; border-radius:6px; font-size:13px; font-family:monospace;">
      <button onclick="updateScriptUrl()" style="background:#1F3864;color:#fff;border:none;padding:10px 18px;border-radius:6px;cursor:pointer;font-size:14px;">Save</button>
    </div>
  </div>

  <!-- Image Archive -->
  <div style="background:#fff; border-radius:10px; border:1px solid #dee2e6; padding:20px;">
    <h3 style="color:#1F3864; margin:0 0 12px 0;">üóÑÔ∏è Image Archive</h3>
    <p style="color:#6c757d; font-size:13px; margin-bottom:16px;">Images that have been deleted (archived) from defect categories. You can restore them here.</p>
    <div id="image-archive-list">Loading archive...</div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- CHANGE SUBMISSION MODAL                                         -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="change-submit-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:2000; align-items:center; justify-content:center;">
  <div style="background:#fff; border-radius:12px; padding:28px; max-width:480px; width:90%; box-shadow:0 20px 60px rgba(0,0,0,0.3);">
    <h3 style="color:#1F3864; margin:0 0 6px 0;">üìù Submit Change for Approval</h3>
    <p style="color:#6c757d; font-size:13px; margin:0 0 20px 0;">Your change will be reviewed by an approver before going live.</p>
    <div id="change-submit-details" style="background:#f8f9fa; border-radius:8px; padding:14px; margin-bottom:16px; font-size:13px;"></div>
    <label style="font-size:13px; font-weight:600; color:#495057; display:block; margin-bottom:6px;">Reason for change (optional):</label>
    <textarea id="change-reason" rows="3" placeholder="Explain why this change is needed..."
      style="width:100%; padding:10px; border:1px solid #dee2e6; border-radius:6px; font-size:13px; resize:vertical; box-sizing:border-box; margin-bottom:16px;"></textarea>
    <div style="display:flex; gap:10px; justify-content:flex-end;">
      <button onclick="closeChangeModal()" style="background:#6c757d;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;">Cancel</button>
      <button onclick="confirmSubmitChange()" style="background:#1F3864;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:600;">Submit for Approval</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- IMAGE UPLOAD MODAL                                              -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="image-upload-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:2000; align-items:center; justify-content:center;">
  <div style="background:#fff; border-radius:12px; padding:28px; max-width:480px; width:90%; box-shadow:0 20px 60px rgba(0,0,0,0.3);">
    <h3 style="color:#1F3864; margin:0 0 6px 0;">üì∏ Upload FA Image</h3>
    <p style="color:#6c757d; font-size:13px; margin:0 0 16px 0;">Upload an image to the <strong id="upload-category-label"></strong> section. It will be stored in Google Drive.</p>
    <div id="upload-drop-zone"
      style="border:2px dashed #dee2e6; border-radius:8px; padding:30px; text-align:center; margin-bottom:16px; cursor:pointer; transition:border-color 0.2s;"
      onclick="document.getElementById('upload-file-input').click()"
      ondragover="event.preventDefault(); this.style.borderColor='#1F3864';"
      ondragleave="this.style.borderColor='#dee2e6';"
      ondrop="handleImageDrop(event)">
      <div style="font-size:32px; margin-bottom:8px;">üìÅ</div>
      <div style="color:#6c757d; font-size:14px;">Click to browse or drag & drop an image here</div>
      <div style="color:#adb5bd; font-size:12px; margin-top:4px;">JPG, PNG, GIF up to 5 MB</div>
    </div>
    <input type="file" id="upload-file-input" accept="image/*" style="display:none;" onchange="handleImageFileSelect(event)">
    <div id="upload-preview" style="display:none; margin-bottom:16px; text-align:center;">
      <img id="upload-preview-img" style="max-width:100%; max-height:200px; border-radius:6px; border:1px solid #dee2e6;">
    </div>
    <label style="font-size:13px; font-weight:600; color:#495057; display:block; margin-bottom:6px;">Caption (optional):</label>
    <input type="text" id="upload-caption" placeholder="e.g., BD Type 2 Ti particle SEM cross-section"
      style="width:100%; padding:10px; border:1px solid #dee2e6; border-radius:6px; font-size:13px; box-sizing:border-box; margin-bottom:16px;">
    <div style="display:flex; gap:10px; justify-content:flex-end;">
      <button onclick="closeImageUploadModal()" style="background:#6c757d;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;">Cancel</button>
      <button onclick="confirmImageUpload()" id="upload-confirm-btn" style="background:#2E7D32;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:600;">Upload to Drive</button>
    </div>
  </div>
</div>

</body>
</html>
